<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Šipky – zapis skóre</title>
  <style>
    :root{
      --bg:#0f1220;--fg:#e8ebf8;--muted:#aeb3c7;--card:#171a2b;--accent:#6ee7ff;--accent2:#9bff6e;--danger:#ff6e6e;--warn:#ffd56e;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0e1a,#12152a 40%,#0b0e1a);color:var(--fg);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial}
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 40px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:6px 0 16px}
    .title{font-weight:800;letter-spacing:.3px;font-size:20px;display:flex;align-items:center;gap:10px}
    .pill{background:var(--card);border:1px solid #2d3353;border-radius:14px;padding:6px 10px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{background:var(--card);border:1px solid #2d3353;border-radius:18px;padding:14px;box-shadow:var(--shadow)}
    .col h3{margin:6px 0 12px;font-size:16px}
    .grow{flex:1 1 340px}
    .side{flex:0 1 330px}
    .controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
    select, input[type="text"], input[type="number"], button{background:#0e1121;color:var(--fg);border:1px solid #2d3353;border-radius:12px;padding:8px 10px;font:inherit}
    button{cursor:pointer;transition:transform .05s ease, background .2s}
    button:hover{transform:translateY(-1px)}
    button.primary{background:linear-gradient(180deg,#1a2a5a,#15224a);border-color:#35407a}
    button.ghost{background:transparent}
    button.warn{background:#402b00;border-color:#6d4a00}
    button.danger{background:#3a0b0b;border-color:#652828}

    .keypad{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .key{padding:12px 0;text-align:center;border-radius:12px;border:1px solid #2d3353;background:#101431;font-weight:700}
    .key.miss{background:#2a1420}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid #2d3353;background:#0f142f;cursor:pointer}
    .chip.active{outline:2px solid var(--accent);}

    .players{display:flex;flex-direction:column;gap:8px}
    .player{display:flex;align-items:center;gap:8px;justify-content:space-between;background:#121634;border:1px solid #2d3353;border-radius:12px;padding:8px}
    .player .name{font-weight:700}
    .player .score{font-variant-numeric:tabular-nums}

    .turn{display:flex;align-items:center;gap:8px;margin:4px 0;color:var(--muted)}
    .turn .dot{width:8px;height:8px;border-radius:50%;background:#3a416b}

    .tabs{display:flex;gap:6px}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid #2d3353;background:#0e1229;cursor:pointer}
    .tab.active{outline:2px solid var(--accent)}

    .history{max-height:340px;overflow:auto;border-radius:12px;border:1px solid #2d3353;background:#0b0e1f}
    .hist-row{padding:8px 12px;border-bottom:1px solid #242a4a}
    .hist-row:last-child{border-bottom:none}

    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid #2d3353;text-align:left}
    .muted{color:var(--muted)}
    .small{font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <!-- obsah stránek jako předtím, beze změny -->
</div>

<audio id="voice" preload="auto"></audio>

<script>
// stejné jako předtím, jen úpravy ve finishTurn a enterScore + renderPlayers

function enterScore(base, mul){
  mul = mul || state.multiplier;
  const player = currentPlayer();
  if(!player){ alert('Žádní hráči.'); return; }
  const score = base*mul;
  if(state.soundOn && document.getElementById('announceEveryClick').checked){ playNumber(score); }
  if(!player.turnThrows) player.turnThrows=[];
  if(player.turnThrows.length>=3){ finishTurn(); return; }
  player.turnThrows.push({base, mul, score});
  renderPlayers();
  renderLiveHistory();
  if(player.turnThrows.length===3){ finishTurn(); }
  // reset multiplikátoru na Single
  state.multiplier = 1;
  document.querySelectorAll('#multiplier .chip').forEach(c=>c.classList.remove('active'));
  document.querySelector('#multiplier .chip[data-mul="1"]').classList.add('active');
}

function finishTurn(){
  const player = currentPlayer();
  if(!player) return;
  const darts = player.turnThrows||[];
  if(darts.length===0){ nextPlayer(); renderPlayers(); updateTurnInfo(); return; }
  const turnTotal = darts.reduce((a,d)=>a+d.score,0);
  let remaining = player.remaining - turnTotal;
  let bust = false;
  if(remaining < 0){ bust = true; remaining = player.remaining; }
  else if(remaining === 0){
    if(state.doubleOut){
      const last = darts[darts.length-1];
      if(last.mul!==2){ bust = true; remaining = player.remaining; }
    }
  }
  else if(state.doubleOut && remaining===1){ bust = true; remaining = player.remaining; }
  if(!bust){ player.remaining = remaining; }
  const record = { playerId: player.id, playerName: player.name, darts: structuredClone(darts), turnTotal, bust, remainingAfter: player.remaining, when: new Date().toISOString() };
  state.leg.turns.push(record);
  if(state.soundOn && document.getElementById('announceTurnTotal').checked){ playNumber(turnTotal); }
  if(player.remaining===0){
    const winnerId = player.id;
    state.history.legs.push({ ...state.leg, winnerId });
    const hp = state.history.players.find(p=>p.id===player.id);
    if(hp){ hp.wins = (hp.wins||0)+1; }
    saveHistory();
    alert(`Vítěz: ${player.name}!`);
    setStatus(`Vítěz: ${player.name}`);
    startNewLeg();
    renderLeaderboard();
    return;
  }
  player.turnThrows = [];
  nextPlayer();
  renderPlayers();
  renderLiveHistory();
  updateTurnInfo();
  saveHistory();
}

function renderPlayers(){
  const box = document.getElementById('players');
  box.innerHTML='';
  state.players.forEach((p,i)=>{
    const throwsText = p.turnThrows && p.turnThrows.length ? ' ['+p.turnThrows.map(formatDart).join(', ')+']' : '';
    const el = document.createElement('div');
    el.className='player';
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <div class="pill" style="${i===state.currentIndex?'outline:2px solid var(--accent);':''}">${i===state.currentIndex?'▶️':''} ${i+1}</div>
        <div class="name">${escapeHtml(p.name)}${throwsText}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="score">${p.remaining}</div>
        <button class="ghost" title="Odebrat" onclick="removePlayer('${p.id}')">✖</button>
      </div>`;
    box.appendChild(el);
  });
  updateTurnInfo();
}
</script>
</body>
</html>
