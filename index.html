<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>≈†ipky ‚Äì zapis sk√≥re</title>
  <style>
    /* ------------------------------
       T√âMATA A PROMƒöNN√â
       ------------------------------ */
    :root{
      /* v√Ωchoz√≠ (dark-neon) */
      --bg1:#0b0e1a; --bg2:#12152a;
      --fg:#e8ebf8; --muted:#aeb3c7;
      --card:#171a2b; --border:#2d3353;
      --accent:#6ee7ff; --accent2:#9bff6e;
      --danger:#ff6e6e; --warn:#ffd56e;

      /* barvy n√°sobk≈Ø */
      --mul1:#0f142f; /* single */
      --mul2:#10321f; /* double */
      --mul3:#3a1a12; /* triple */

      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    body.theme-light{
      --bg1:#f6f8ff; --bg2:#e9eefb; --fg:#0f1230; --muted:#4b5070;
      --card:#ffffff; --border:#cfd6f1; --accent:#1e60ff; --accent2:#0fb66f;
      --danger:#e54747; --warn:#d9a000;
      --mul1:#eef2ff; --mul2:#e6fff0; --mul3:#fff0ea;
    }
    body.theme-contrast{
      --bg1:#000000; --bg2:#000000; --fg:#ffffff; --muted:#d0d0d0;
      --card:#000000; --border:#ffffff; --accent:#ffff00; --accent2:#00ff88;
      --danger:#ff0033; --warn:#ffcc00;
      --mul1:#111111; --mul2:#002b11; --mul3:#2b0000;
    }

    /* ------------------------------
       Z√ÅKLADN√ç STYL
       ------------------------------ */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2) 40%,var(--bg1));color:var(--fg);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial}
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 100px}

    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg1) 85%,rgba(0,0,0,0));backdrop-filter:saturate(120%) blur(4px);display:flex;gap:12px;align-items:center;justify-content:space-between;margin:0 0 16px;padding:8px 0 10px}
    .title{font-weight:800;letter-spacing:.3px;font-size:20px;display:flex;align-items:center;gap:10px}
    .pill{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:6px 10px;color:var(--muted)}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
    .col h3{margin:6px 0 12px;font-size:16px}
    .grow{flex:1 1 360px}
    .side{flex:0 1 320px}

    .controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
    select, input[type="text"], input[type="number"], button{background:#0e1121;color:var(--fg);border:1px solid var(--border);border-radius:12px;padding:10px 12px;font:inherit}
    body.theme-light select, body.theme-light input, body.theme-light button{background:#fff}
    input::placeholder{color:#8087a8}
    button{cursor:pointer;transition:transform .05s ease, background .2s}
    button:hover{transform:translateY(-1px)}
    button.primary{background:linear-gradient(180deg,#1a2a5a,#15224a);border-color:#35407a}
    body.theme-light button.primary{background:linear-gradient(180deg,#2a6bff,#1d4fd8);color:white;border-color:#2a6bff}
    button.ghost{background:transparent}
    button.warn{background:#402b00;border-color:#6d4a00}
    button.danger{background:#3a0b0b;border-color:#652828}
    button[disabled]{opacity:.5;cursor:not-allowed}

    .keypad{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .key{padding:14px 0;text-align:center;border-radius:12px;border:1px solid var(--border);background:#101431;font-weight:800;font-size:18px}
    body.theme-light .key{background:#f7f8ff}
    .key.miss{background:#2a1420}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#0f142f;cursor:pointer;user-select:none}
    .chip input{margin-right:6px}
    .chip.active{outline:2px solid var(--accent);}

    /* barevn√© multiplik√°tory */
    body.color-keys #multiplier .chip[data-mul="1"]{background:var(--mul1)}
    body.color-keys #multiplier .chip[data-mul="2"]{background:var(--mul2)}
    body.color-keys #multiplier .chip[data-mul="3"]{background:var(--mul3)}

    .players{display:flex;flex-direction:column;gap:8px}
    .player{display:flex;align-items:center;gap:8px;justify-content:space-between;background:#121634;border:1px solid var(--border);border-radius:12px;padding:10px}
    body.theme-light .player{background:#f6f7ff}
    .player .name{font-weight:700}
    .player .score{font-variant-numeric:tabular-nums;font-size:18px}

    .turn{display:flex;align-items:center;gap:8px;margin:4px 0;color:var(--muted)}
    .turn .dot{width:8px;height:8px;border-radius:50%;background:#3a416b}

    .tabs{display:flex;gap:6px}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0e1229;cursor:pointer}
    .tab.active{outline:2px solid var(--accent)}

    .history{max-height:340px;overflow:auto;border-radius:12px;border:1px solid var(--border);background:#0b0e1f}
    body.theme-light .history{background:#ffffff}
    .hist-row{padding:8px 12px;border-bottom:1px solid #242a4a}
    .hist-row:last-child{border-bottom:none}

    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    .muted{color:var(--muted)}
    .small{font-size:12px}

    /* Schov√°v√°n√≠ p≈ôi aktivn√≠ h≈ôe */
    body.playing .hide-when-playing{display:none !important}
    /* Voliteln√© minim√°ln√≠ UI ‚Äì schovat, pokud je v nastaven√≠ zapnuto */
    body.minimal.playing .hide-during-play{display:none !important}

    /* Lepiv√Ω informaƒçn√≠ panel dole */
    .stickybar{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:rgba(0,0,0,.65);color:#fff;border-top:1px solid var(--border);display:none}
    body.theme-light .stickybar{background:rgba(255,255,255,.92);color:#14203b}
    body.sticky-info .stickybar{display:block}

    /* Mobiln√≠ √∫pravy */
    @media (max-width: 800px){
      .controls{grid-template-columns:repeat(2,minmax(0,1fr))}
      .side{flex:1 1 100%}
      .grow{flex:1 1 100%}
      .keypad{grid-template-columns:repeat(5,1fr)}
      .key{padding:16px 0;font-size:20px}
      .tabs{flex-wrap:wrap}
      header{gap:8px}
    }
    @media (max-width: 480px){
      .keypad{grid-template-columns:repeat(4,1fr)}
      .chip{padding:10px 12px}
      .title{font-size:18px}
    }
  </style>
</head>
<body class="theme-dark color-keys sticky-info minimal">
<div class="wrap">
  <header>
    <div class="title">üéØ <span>≈†ipky ‚Äì zapis sk√≥re</span><span class="pill" id="statusPill">P≈ôipraveno</span></div>
    <div class="tabs hide-when-playing">
      <button class="tab active" data-tab="game">Hra</button>
      <button class="tab" data-tab="history">Historie</button>
      <button class="tab" data-tab="leaderboard">≈Ωeb≈ô√≠ƒçek</button>
      <button class="tab" data-tab="settings">Nastaven√≠</button>
    </div>
  </header>

  <!-- GAME TAB -->
  <section data-panel="game">
    <div class="row">
      <div class="col side">
        <h3>Hr√°ƒçi</h3>
        <div class="players" id="players"></div>
        <div class="controls" style="margin-top:10px">
          <div class="hide-when-playing" style="display:contents">
            <input id="newPlayerName" placeholder="Jm√©no hr√°ƒçe" />
            <button class="primary" id="addPlayerBtn" onclick="addPlayer()">P≈ôidat hr√°ƒçe</button>
          </div>
          <button class="warn hide-during-play" onclick="startNewLeg()">Nov√© kolo (leg)</button>
          <button class="ghost" onclick="undoLastDart()">Zpƒõt posledn√≠ hod</button>
        </div>
      </div>

      <div class="col grow">
        <h3>Volba hry</h3>
        <div class="chips hide-during-play" style="margin-bottom:8px" id="gameOptions">
          <label class="chip"><input type="radio" name="x01" value="101" onchange="setGame(101)"/> 101</label>
          <label class="chip"><input type="radio" name="x01" value="301" checked onchange="setGame(301)"/> 301</label>
          <label class="chip"><input type="radio" name="x01" value="501" onchange="setGame(501)"/> 501</label>
          <label class="chip"><input type="radio" name="x01" value="701" onchange="setGame(701)"/> 701</label>
          <label class="chip"><input type="checkbox" id="doubleOut" onchange="toggleDoubleOut(this.checked)"/> Double-out</label>
          <label class="chip"><input type="checkbox" id="soundToggle" checked onchange="toggleSound(this.checked)"/> ƒå√≠st hodnoty</label>
        </div>

        <div class="row">
          <div class="col grow">
            <h3>Hody (vyber n√°sobek a hodnotu)</h3>
            <div class="chips" id="multiplier">
              <button class="chip active" data-mul="1">Single</button>
              <button class="chip" data-mul="2">Double</button>
              <button class="chip" data-mul="3">Triple</button>
            </div>
            <div class="keypad" style="margin-top:10px" id="keypad"></div>
            <div class="chips" style="margin-top:8px">
              <button class="chip" onclick="enterScore(0,1)">Chyba (0)</button>
              <button class="chip" style="outline:2px solid var(--accent2)" onclick="finishTurn()">Ukonƒçit tah</button>
            </div>
            <div class="turn small" id="turnInfo"><span class="dot"></span>Na tahu: ‚Äì</div>
          </div>

          <div class="col side hide-during-play">
            <h3>Pr≈Øbƒõh kola</h3>
            <div class="history" id="liveHistory"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- HISTORY TAB -->
  <section data-panel="history" hidden>
    <div class="row">
      <div class="col grow">
        <h3>Historie (v≈°e)</h3>
        <div class="history" id="fullHistory"></div>
      </div>
      <div class="col side">
        <h3>Export / Import</h3>
        <div class="controls">
          <button class="primary" onclick="downloadHistory()">St√°hnout JSON</button>
          <input type="file" id="importFile" accept="application/json"/>
          <button onclick="importHistory()">Naƒç√≠st JSON</button>
          <button class="danger" onclick="clearAll()">Smazat v≈°e</button>
        </div>
        <p class="small muted">JSON obsahuje kompletn√≠ historii (hr√°ƒçi, kola, hody, v√≠tƒõzov√©). Lze p≈ôen√©st na jin√Ω poƒç√≠taƒç.</p>
      </div>
    </div>
  </section>

  <!-- LEADERBOARD TAB -->
  <section data-panel="leaderboard" hidden>
    <div class="col grow">
      <h3>≈Ωeb≈ô√≠ƒçek v√≠tƒõzstv√≠</h3>
      <table class="table" id="leaderTable">
        <thead><tr><th>Po≈ôad√≠</th><th>Hr√°ƒç</th><th>V√Ωhry</th></tr></thead>
        <tbody></tbody>
      </table>
      <p class="small muted">≈Ωeb≈ô√≠ƒçek se aktualizuje po ka≈æd√©m ukonƒçen√©m legu.</p>
    </div>
  </section>

  <!-- SETTINGS TAB -->
  <section data-panel="settings" hidden>
    <div class="col grow">
      <h3>Vzhled &amp; rozhran√≠</h3>
      <div class="controls" style="grid-template-columns:repeat(2,minmax(0,1fr));max-width:680px">
        <label> T√©ma
          <select id="themeSelect">
            <option value="theme-dark">Tmav√© (Neon)</option>
            <option value="theme-light">Svƒõtl√©</option>
            <option value="theme-contrast">Vysok√Ω kontrast</option>
          </select>
        </label>
        <label><input type="checkbox" id="colorizeKeys" checked/> Barevnƒõ odli≈°it Single/Double/Triple</label>
        <label><input type="checkbox" id="minimalUi" checked/> Minimal UI bƒõhem hry (skryje nepot≈ôebn√° tlaƒç√≠tka)</label>
        <label><input type="checkbox" id="stickyBarToggle" checked/> Pevn√Ω panel sk√≥re dole</label>
      </div>
      <p class="small muted">Bƒõhem hry je zak√°z√°no p≈ôid√°vat hr√°ƒçe (pro p≈ôid√°n√≠ ukonƒçete leg, nebo zaƒçnƒõte nov√Ω p≈ôed prvn√≠m hodem).</p>
      <h3>Soubory pro ƒçten√≠ hodnot</h3>
      <p class="muted small">Um√≠stƒõte sv√© zvukov√© soubory do slo≈æky <code>audio/</code> vedle t√©to str√°nky. N√°zvy: <code>1.mp3</code>, <code>2.mp3</code>, ‚Ä¶, <code>180.mp3</code>. Hraje se v√Ωsledn√° hodnota (n√°sobek √ó ƒç√≠slo). Pro bull: 25 a 50.</p>
      <div class="controls" style="max-width:520px;margin-top:10px">
        <label><input type="checkbox" id="announceEveryClick" checked/> P≈ôehr√°vat p≈ôi ka≈æd√©m kliku</label>
        <label><input type="checkbox" id="announceTurnTotal"/> P≈ôeƒç√≠st souƒçet t≈ô√≠ hod≈Ø na konci tahu (pokud existuje soubor)</label>
      </div>
    </div>
  </section>
</div>

<div class="stickybar" id="stickyBar">‚Äî</div>
<audio id="voice" preload="auto"></audio>

<script>
// ------------------------
// Stav aplikace
// ------------------------
const state = {
  startingScore: 301,
  doubleOut: false,
  soundOn: true,
  players: [], // {id, name, remaining, turnThrows:[], wins}
  currentIndex: 0,
  leg: { id: ts(), turns: [] },
  history: loadHistory(),
  multiplier: 1,
  settings: loadSettings(),
};

function ts(){ return Date.now(); }

// --- persistentn√≠ √∫lo≈æi≈°tƒõ ---
function loadHistory(){
  try{ return JSON.parse(localStorage.getItem('dartsHistoryV1')) || { players:[], legs:[] }; }
  catch(e){ return { players:[], legs:[] }; }
}
function saveHistory(){ localStorage.setItem('dartsHistoryV1', JSON.stringify(state.history)); }
function loadSettings(){
  try{ return JSON.parse(localStorage.getItem('dartsSettingsV1')) || { theme:'theme-dark', colorizeKeys:true, minimalUi:true, stickyBar:true }; }
  catch(e){ return { theme:'theme-dark', colorizeKeys:true, minimalUi:true, stickyBar:true }; }
}
function saveSettings(){ localStorage.setItem('dartsSettingsV1', JSON.stringify(state.settings)); }
function loadActive(){
  try{ return JSON.parse(localStorage.getItem('dartsActiveV1')) || null; }
  catch(e){ return null; }
}
function saveActive(){
  const snapshot = {
    startingScore: state.startingScore,
    doubleOut: state.doubleOut,
    players: state.players,
    currentIndex: state.currentIndex,
    leg: state.leg,
  };
  localStorage.setItem('dartsActiveV1', JSON.stringify(snapshot));
}
function clearActive(){ localStorage.removeItem('dartsActiveV1'); }

// ------------------------
// UI ‚Äì panely
// ------------------------
const panels = document.querySelectorAll('[data-panel]');
const tabs = document.querySelectorAll('.tab');
for (const tab of tabs){
  tab.addEventListener('click', () => {
    tabs.forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const target = tab.getAttribute('data-tab');
    panels.forEach(p=>p.hidden = p.getAttribute('data-panel')!==target);
    if (target==='history') renderFullHistory();
    if (target==='leaderboard') renderLeaderboard();
  });
}
function setStatus(msg){ document.getElementById('statusPill').textContent = msg; }

// ------------------------
// Hr√°ƒçi a hra
// ------------------------
function isInProgress(){
  return (state.leg && state.leg.turns && state.leg.turns.length>0) || state.players.some(p=>p.turnThrows && p.turnThrows.length>0);
}

function addPlayer(){
  if(isInProgress()) { alert('Bƒõhem hry nelze p≈ôid√°vat hr√°ƒçe. Ukonƒçete leg, nebo zaƒçnƒõte nov√Ω p≈ôed prvn√≠m hodem.'); return; }
  const inp = document.getElementById('newPlayerName');
  const name = (inp.value||'').trim();
  if(!name) return;
  const id = 'p'+ts();
  const existing = state.history.players.find(p=>p.name.toLowerCase()===name.toLowerCase());
  const wins = existing? existing.wins||0 : 0;
  const player = { id, name, wins, remaining: state.startingScore, turnThrows:[] };
  state.players.push(player);
  if(!existing) state.history.players.push({id, name, wins});
  inp.value='';
  renderPlayers();
  saveHistory();
  saveActive();
  if(state.players.length===1) setStatus('P≈ôidejte dal≈°√≠ hr√°ƒçe nebo zaƒçnƒõte h√°zet.');
}

function removePlayer(id){
  if(isInProgress()) { alert('Bƒõhem hry nelze upravovat soupisku.'); return; }
  const idx = state.players.findIndex(p=>p.id===id);
  if(idx>-1){
    state.players.splice(idx,1);
    if(state.currentIndex>=state.players.length) state.currentIndex=0;
    renderPlayers();
    saveActive();
  }
}

function setGame(val){
  if(isInProgress()) { alert('Nelze mƒõnit typ hry v pr≈Øbƒõhu legu.'); return; }
  state.startingScore = Number(val);
  for(const p of state.players){ p.remaining = state.startingScore; p.turnThrows=[]; }
  state.leg = { id: ts(), turns: [] };
  renderPlayers();
  renderLiveHistory();
  setStatus(`Nastaveno ${state.startingScore}.`);
  saveActive();
}

function toggleDoubleOut(on){ if(isInProgress()){ alert('Double-out lze mƒõnit jen p≈ôed legem.'); document.getElementById('doubleOut').checked=state.doubleOut; return;} state.doubleOut = on; setStatus(`Double-out ${on?'zapnuto':'vypnuto'}.`); saveActive(); }
function toggleSound(on){ state.soundOn = on; setStatus(`ƒåten√≠ hodnot ${on?'zapnuto':'vypnuto'}.`); saveActive(); }

function startNewLeg(){
  if(state.players.length===0){ alert('P≈ôidejte alespo≈à jednoho hr√°ƒçe.'); return; }
  for(const p of state.players){ p.remaining = state.startingScore; p.turnThrows=[]; }
  state.currentIndex = 0;
  state.leg = { id: ts(), turns: [], startingScore: state.startingScore, doubleOut: state.doubleOut, createdAt: new Date().toISOString() };
  renderPlayers();
  renderLiveHistory();
  setStatus('Zaƒç√≠n√° nov√© kolo.');
  updateUI();
  saveActive();
}

function currentPlayer(){ return state.players[state.currentIndex]; }
function nextPlayer(){ state.currentIndex = (state.currentIndex+1) % state.players.length; }

// ------------------------
// Zad√°v√°n√≠ hod≈Ø
// ------------------------
function enterScore(base, mul){
  mul = mul || state.multiplier;
  const player = currentPlayer();
  if(!player){ alert('≈Ω√°dn√≠ hr√°ƒçi.'); return; }
  const score = base*mul; // 0, 1..180

  if(state.soundOn && document.getElementById('announceEveryClick').checked){ playNumber(score); }

  if(!player.turnThrows) player.turnThrows=[];
  if(player.turnThrows.length>=3){ finishTurn(); return; }
  player.turnThrows.push({base, mul, score});
  renderPlayers();
  renderLiveHistory();

  if(player.turnThrows.length===3){ finishTurn(); }

  // reset multiplik√°toru na Single po ka≈æd√©m zad√°n√≠
  state.multiplier = 1;
  document.querySelectorAll('#multiplier .chip').forEach(c=>c.classList.remove('active'));
  document.querySelector('#multiplier .chip[data-mul="1"]').classList.add('active');

  updateUI();
  saveActive();
}

function finishTurn(){
  const player = currentPlayer();
  if(!player) return;
  const darts = player.turnThrows||[];

  if(darts.length===0){ nextPlayer(); renderPlayers(); updateTurnInfo(); updateSticky(); saveActive(); return; }

  const turnTotal = darts.reduce((a,d)=>a+d.score,0);
  let remaining = player.remaining - turnTotal;

  let bust = false;
  if(remaining < 0){ bust = true; remaining = player.remaining; }
  else if(remaining === 0){
    if(state.doubleOut){
      const last = darts[darts.length-1];
      if(last.mul!==2){ bust = true; remaining = player.remaining; }
    }
  }
  else if(state.doubleOut && remaining===1){ bust = true; remaining = player.remaining; }

  if(!bust){ player.remaining = remaining; }

  const record = { playerId: player.id, playerName: player.name, darts: structuredClone(darts), turnTotal, bust, remainingAfter: player.remaining, when: new Date().toISOString() };
  state.leg.turns.push(record);

  if(state.soundOn && document.getElementById('announceTurnTotal').checked){ playNumber(turnTotal); }

  if(player.remaining===0){
    const winnerId = player.id;
    state.history.legs.push({ ...state.leg, winnerId });
    const hp = state.history.players.find(p=>p.id===player.id);
    if(hp){ hp.wins = (hp.wins||0)+1; }
    saveHistory();
    alert(`V√≠tƒõz: ${player.name}!`);
    setStatus(`V√≠tƒõz: ${player.name}`);
    startNewLeg();
    renderLeaderboard();
    updateUI();
    saveActive();
    return;
  }

  player.turnThrows = [];
  nextPlayer();
  renderPlayers();
  renderLiveHistory();
  updateTurnInfo();
  saveHistory();
  updateUI();
  saveActive();
}

function undoLastDart(){
  const p = currentPlayer();
  if(p && p.turnThrows && p.turnThrows.length>0){
    p.turnThrows.pop();
    renderPlayers();
    renderLiveHistory();
    updateUI();
    saveActive();
    return;
  }
  const last = state.leg.turns[state.leg.turns.length-1];
  if(!last){ setStatus('Nic k vr√°cen√≠.'); return; }
  const idx = state.players.findIndex(pl=>pl.id===last.playerId);
  if(idx!==-1) state.currentIndex = idx;
  const pl = currentPlayer();
  pl.remaining = last.bust ? pl.remaining : last.remainingAfter + last.turnTotal;
  pl.turnThrows = last.darts;
  state.leg.turns.pop();
  renderPlayers();
  renderLiveHistory();
  updateUI();
  saveActive();
}

// ------------------------
// Zvuk
// ------------------------
function playNumber(n){
  const audio = document.getElementById('voice');
  const src = `audio/${n}.mp3`;
  audio.src = src;
  audio.play().catch(()=>{});
}

// ------------------------
// Renderov√°n√≠
// ------------------------
function renderPlayers(){
  const box = document.getElementById('players');
  box.innerHTML='';
  state.players.forEach((p,i)=>{
    const throwsText = p.turnThrows && p.turnThrows.length ? ' ['+p.turnThrows.map(formatDartShort).join(', ')+']' : '';
    const el = document.createElement('div');
    el.className='player';
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <div class="pill" style="${i===state.currentIndex?'outline:2px solid var(--accent);':''}">${i===state.currentIndex?'‚ñ∂Ô∏è':''} ${i+1}</div>
        <div class="name">${escapeHtml(p.name)}${throwsText}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="score">${p.remaining}</div>
        <button class="ghost hide-when-playing" title="Odebrat" onclick="removePlayer('${p.id}')">‚úñ</button>
      </div>`;
    box.appendChild(el);
  });
  updateTurnInfo();
  updateSticky();
  // Disable/hide add controls podle stavu
  const playing = isInProgress();
  const nameInp = document.getElementById('newPlayerName');
  const addBtn = document.getElementById('addPlayerBtn');
  if(nameInp) nameInp.disabled = playing;
  if(addBtn) addBtn.disabled = playing;
}

function renderLiveHistory(){
  const box = document.getElementById('liveHistory');
  if(!box) return;
  box.innerHTML='';
  const p = currentPlayer();
  if(p && p.turnThrows && p.turnThrows.length){
    const row = document.createElement('div');
    row.className='hist-row';
    row.innerHTML = `<div><b>${escapeHtml(p.name)}</b> ‚Äì rozpracovan√Ω tah: ${p.turnThrows.map(formatDart).join(', ')} (=${p.turnThrows.reduce((a,d)=>a+d.score,0)})</div>`;
    box.appendChild(row);
  }
  for(let i=state.leg.turns.length-1;i>=0;i--){
    const t = state.leg.turns[i];
    const row = document.createElement('div');
    row.className='hist-row';
    row.innerHTML = `<div><b>${escapeHtml(t.playerName)}</b> ‚Üí ${t.darts.map(formatDart).join(', ')} <span class="muted">(=${t.turnTotal})</span> ${t.bust?'<span style="color:var(--warn)">BUST</span>':''} <span class="muted small">z≈Østatek: ${t.remainingAfter}</span></div>`;
    box.appendChild(row);
  }
}

function renderFullHistory(){
  const box = document.getElementById('fullHistory');
  if(!box) return;
  box.innerHTML='';
  if(state.history.legs.length===0){ box.innerHTML = '<div class="hist-row muted">Zat√≠m ≈æ√°dn√° odehran√° kola.</div>'; return; }
  state.history.legs.slice().reverse().forEach((leg,idx)=>{
    const wrap = document.createElement('div');
    wrap.className='hist-row';
    const winner = state.history.players.find(p=>p.id===leg.winnerId);
    wrap.innerHTML = `<div><b>Leg #${state.history.legs.length-idx}</b> ‚Ä¢ start: ${leg.startingScore} ‚Ä¢ ${leg.doubleOut?'double-out':'standard'} ‚Ä¢ v√≠tƒõz: <b>${winner?escapeHtml(winner.name):'?'}</b> <span class="small muted">${new Date(leg.createdAt||Date.now()).toLocaleString()}</span></div>`;
    leg.turns.forEach(t=>{
      const line = document.createElement('div');
      line.className='small muted';
      line.style.marginLeft='8px';
      line.textContent = `${t.playerName}: ${t.darts.map(d=>`${d.mul}√ó${d.base}=${d.score}`).join(', ')} = ${t.turnTotal}${t.bust?' (BUST)':''} ‚Üí ${t.remainingAfter}`;
      wrap.appendChild(line);
    });
    box.appendChild(wrap);
  });
}

function renderLeaderboard(){
  const tbody = document.querySelector('#leaderTable tbody');
  if(!tbody) return;
  const arr = state.history.players.slice().sort((a,b)=>(b.wins||0)-(a.wins||0));
  tbody.innerHTML = arr.map((p,i)=>`<tr><td>${i+1}.</td><td>${escapeHtml(p.name)}</td><td>${p.wins||0}</td></tr>`).join('');
}

function updateTurnInfo(){
  const el = document.getElementById('turnInfo');
  const p = currentPlayer();
  el.innerHTML = `<span class="dot"></span>Na tahu: <b>${p?escapeHtml(p.name):'‚Äì'}</b> ‚Ä¢ Zb√Ωv√°: ${p?p.remaining:'‚Äì'}`;
}

function updateSticky(){
  const bar = document.getElementById('stickyBar');
  if(!bar) return;
  const p = currentPlayer();
  const throwTxt = p && p.turnThrows && p.turnThrows.length ? p.turnThrows.map(formatDartShort).join(', ') : '‚Äî';
  bar.innerHTML = p ? `Na tahu: <b>${escapeHtml(p.name)}</b> ‚Ä¢ Zb√Ωv√°: <b>${p.remaining}</b> ‚Ä¢ Hody: ${throwTxt}` : '‚Äî';
}

function formatDart(d){
  const m = d.mul===1?'S':(d.mul===2?'D':'T');
  return `${m}${d.base}=${d.score}`;
}
function formatDartShort(d){
  const m = d.mul===1?'S':(d.mul===2?'D':'T');
  return `${m}${d.base}`;
}
function escapeHtml(s){ return (s+"").replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// ------------------------
// Export / Import / Smaz√°n√≠
// ------------------------
function downloadHistory(){
  const data = JSON.stringify(state.history, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `darts_history_${new Date().toISOString().replaceAll(':','-')}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function importHistory(){
  const inp = document.getElementById('importFile');
  if(!inp.files.length){ alert('Vyberte JSON soubor.'); return; }
  const file = inp.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      if(!obj.players || !obj.legs) throw new Error('Neplatn√Ω form√°t.');
      state.history = obj;
      saveHistory();
      renderFullHistory();
      renderLeaderboard();
      alert('Historie √∫spƒõ≈°nƒõ naƒçtena.');
    }catch(e){ alert('Chyba p≈ôi naƒç√≠t√°n√≠ JSON: '+e.message); }
  };
  reader.readAsText(file);
}

function clearAll(){
  if(!confirm('Opravdu smazat ve≈°kerou historii?')) return;
  state.history = { players:[], legs:[] };
  saveHistory();
  renderFullHistory();
  renderLeaderboard();
}

// ------------------------
// Nastaven√≠ vzhledu
// ------------------------
function applySettings(){
  document.body.classList.remove('theme-dark','theme-light','theme-contrast');
  document.body.classList.add(state.settings.theme);
  document.body.classList.toggle('color-keys', !!state.settings.colorizeKeys);
  document.body.classList.toggle('minimal', !!state.settings.minimalUi);
  document.body.classList.toggle('sticky-info', !!state.settings.stickyBar);
  updateUI();
}

function bindSettingsUI(){
  const sel = document.getElementById('themeSelect'); if(sel){ sel.value = state.settings.theme; sel.onchange = ()=>{ state.settings.theme = sel.value; saveSettings(); applySettings(); saveActive(); }; }
  const ck1 = document.getElementById('colorizeKeys'); if(ck1){ ck1.checked = !!state.settings.colorizeKeys; ck1.onchange=()=>{ state.settings.colorizeKeys = ck1.checked; saveSettings(); applySettings(); saveActive(); }; }
  const ck2 = document.getElementById('minimalUi'); if(ck2){ ck2.checked = !!state.settings.minimalUi; ck2.onchange=()=>{ state.settings.minimalUi = ck2.checked; saveSettings(); applySettings(); saveActive(); }; }
  const ck3 = document.getElementById('stickyBarToggle'); if(ck3){ ck3.checked = !!state.settings.stickyBar; ck3.onchange=()=>{ state.settings.stickyBar = ck3.checked; saveSettings(); applySettings(); saveActive(); }; }
}

function updateUI(){
  document.body.classList.toggle('playing', isInProgress());
  updateSticky();
}

// ------------------------
// Init
// ------------------------
function buildKeypad(){
  const pad = document.getElementById('keypad');
  pad.innerHTML='';
  const nums = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,25,50];
  nums.forEach(n=>{
    const b = document.createElement('button');
    b.className='key';
    b.textContent = n;
    b.addEventListener('click', ()=>enterScore(n));
    pad.appendChild(b);
  });
  const miss = document.createElement('button');
  miss.className='key miss';
  miss.textContent='Miss';
  miss.addEventListener('click', ()=>enterScore(0,1));
  pad.appendChild(miss);
}

function setupMultiplierChips(){
  const box = document.getElementById('multiplier');
  box.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      box.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      ch.classList.add('active');
      state.multiplier = Number(ch.dataset.mul);
      saveActive();
    });
  });
}

// Inicializace + obnoven√≠ aktivn√≠ hry
buildKeypad();
setupMultiplierChips();
renderPlayers();
renderLiveHistory();
updateTurnInfo();
applySettings();
bindSettingsUI();

const saved = loadActive();
if(saved && saved.players && saved.players.length){
  state.startingScore = saved.startingScore ?? state.startingScore;
  state.doubleOut = !!saved.doubleOut;
  state.players = saved.players;
  state.currentIndex = saved.currentIndex||0;
  state.leg = saved.leg || state.leg;
  renderPlayers();
  renderLiveHistory();
  updateTurnInfo();
}
updateUI();
</script>
</body>
</html>
