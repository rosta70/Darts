<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>≈†ipky ‚Äì zapis sk√≥re</title>
  <meta name="theme-color" content="#0b0e1a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root{
      --bg1:#0b0e1a; --bg2:#12152a; --fg:#e8ebf8; --muted:#aeb3c7;
      --card:#171a2b; --border:#2d3353; --accent:#6ee7ff; --accent2:#9bff6e;
      --danger:#ff6e6e; --warn:#ffd56e; --shadow:0 10px 30px rgba(0,0,0,.35);
      --mul1:#0f142f; --mul2:#10321f; --mul3:#3a1a12;
    }
    body.theme-light{ --bg1:#f6f8ff; --bg2:#e9eefb; --fg:#0f1230; --muted:#4b5070; --card:#ffffff; --border:#cfd6f1; --accent:#1e60ff; --accent2:#0fb66f; --danger:#e54747; --warn:#d9a000; --mul1:#eef2ff; --mul2:#e6fff0; --mul3:#fff0ea; }
    body.theme-contrast{ --bg1:#000; --bg2:#000; --fg:#fff; --muted:#d0d0d0; --card:#000; --border:#fff; --accent:#ff0; --accent2:#0f8; --danger:#f03; --warn:#fc0; --mul1:#111; --mul2:#002b11; --mul3:#2b0000; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2) 40%,var(--bg1));color:var(--fg);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial}
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 110px}

    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg1) 90%,rgba(0,0,0,0));backdrop-filter:saturate(120%) blur(4px);display:flex;gap:12px;align-items:center;justify-content:space-between;margin:0 0 10px;padding:8px 0 10px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-title{font-weight:800;letter-spacing:.3px;font-size:20px}
    .pill{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:6px 10px;color:var(--muted)}

    .activeTop{display:none;align-items:center;gap:10px;padding:10px 12px;border-radius:16px;border:3px solid var(--accent);background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));box-shadow:0 0 0 3px rgba(110,231,255,0.2), 0 6px 20px rgba(0,0,0,0.35)}
    .activeTop .dot{width:12px;height:12px;border-radius:50%;background:var(--accent2);box-shadow:0 0 10px var(--accent2)}
    body.playing .brand{display:none}
    body.playing .activeTop{display:flex}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
    .col h3{margin:6px 0 12px;font-size:16px}
    .grow{flex:1 1 360px}
    .side{flex:0 1 320px}

    .controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
    select, input[type=text], button{background:#0e1121;color:var(--fg);border:1px solid var(--border);border-radius:12px;padding:10px 12px;font:inherit}
    body.theme-light select, body.theme-light input, body.theme-light button{background:#fff}
    button{cursor:pointer;transition:transform .05s ease}
    button:hover{transform:translateY(-1px)}
    button.primary{background:linear-gradient(180deg,#1a2a5a,#15224a);border-color:#35407a}
    body.theme-light button.primary{background:linear-gradient(180deg,#2a6bff,#1d4fd8);color:#fff;border-color:#2a6bff}
    button.ghost{background:transparent}
    button.warn{background:#402b00;border-color:#6d4a00}
    button.danger{background:#3a0b0b;border-color:#652828}
    button[disabled]{opacity:.5;cursor:not-allowed}

    .keypad{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .key{padding:14px 0;text-align:center;border-radius:12px;border:1px solid var(--border);background:#101431;font-weight:800;font-size:18px}
    body.theme-light .key{background:#f7f8ff}
    .key.miss{background:#2a1420}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#0f142f;cursor:pointer;user-select:none}
    .chip input{margin-right:6px}
    .chip.active{outline:2px solid var(--accent)}

    body.color-keys #multiplier .chip[data-mul="1"]{background:var(--mul1)}
    body.color-keys #multiplier .chip[data-mul="2"]{background:var(--mul2)}
    body.color-keys #multiplier .chip[data-mul="3"]{background:var(--mul3)}

    .players{display:flex;flex-direction:column;gap:8px}
    .player{display:flex;align-items:center;gap:8px;justify-content:space-between;background:#121634;border:1px solid var(--border);border-radius:12px;padding:10px}
    body.theme-light .player{background:#f6f7ff}
    .player .name{font-weight:700}
    .player .score{font-variant-numeric:tabular-nums;font-size:18px}

    .muted{color:var(--muted)}
    .small{font-size:12px}

    .tabs{display:flex;gap:6px}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0e1229;cursor:pointer}
    .tab.active{outline:2px solid var(--accent)}

    .history{max-height:340px;overflow:auto;border-radius:12px;border:1px solid var(--border);background:#0b0e1f}
    body.theme-light .history{background:#fff}
    .hist-row{padding:8px 12px;border-bottom:1px solid #242a4a}
    .hist-row:last-child{border-bottom:none}

    body.playing .hide-when-playing{display:none!important}
    body.minimal.playing .hide-during-play{display:none!important}

    .stickybar{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:rgba(0,0,0,.65);color:#fff;border-top:1px solid var(--border);display:none}
    body.theme-light .stickybar{background:rgba(255,255,255,.92);color:#14203b}
    body.sticky-info .stickybar{display:block}

    .tip{display:inline-block;margin-top:6px;padding:6px 10px;border:1px dashed var(--border);border-radius:10px}

    @media (max-width: 800px){
      .controls{grid-template-columns:repeat(2,minmax(0,1fr))}
      .side{flex:1 1 100%}
      .grow{flex:1 1 100%}
      .keypad{grid-template-columns:repeat(5,1fr)}
      .key{padding:16px 0;font-size:20px}
      .tabs{flex-wrap:wrap}
      header{gap:8px}
    }
    @media (max-width: 480px){
      .keypad{grid-template-columns:repeat(4,1fr)}
      .chip{padding:10px 12px}
      .brand-title{font-size:18px}
    }
  #activeTopName{font-size:22px;font-weight:900;letter-spacing:.3px;text-transform:uppercase}
#activeTopRemain, #activeTopThrows, #activeTopTip{font-size:16px}
/* === Svƒõtl√© t√©ma ‚Äì viditeln√© ovl√°dac√≠ prvky === */
body.theme-light .tab{background:#eef3ff}
body.theme-light .chip{background:#ffffff}
body.theme-light #multiplier .chip[data-mul="1"]{background:var(--mul1)}
body.theme-light #multiplier .chip[data-mul="2"]{background:var(--mul2)}
body.theme-light #multiplier .chip[data-mul="3"]{background:var(--mul3)}
body.theme-light .player{background:#ffffff}
body.theme-light .key{background:#f7f9ff}
body.theme-light .key.miss{background:#ffe8ee}
body.theme-light .history{background:#ffffff}
body.theme-light button{border-color:#cfd6f1;color:#0f1230}
body.theme-light button.primary{background:linear-gradient(180deg,#f0f4ff,#e3e9ff);border-color:#b9d1ff;color:#0f1230}
body.theme-light button.warn{background:#fff4d6;border-color:#e8c66a;color:#5a3b00}
body.theme-light button.danger{background:#ffe5e5;border-color:#f5a3a3;color:#7a1a1a}
/* === Svƒõtl√© t√©ma ‚Äì opravy viditelnosti hr√°ƒç≈Ø === */
/* Zajist√≠me kontrast pro v≈°echny svƒõtl√© varianty */
body.theme-light .col,
body.theme-light-blue .col,
body.theme-light-mint .col,
body.theme-light-rose .col,
body.theme-light-sand .col,
body.theme-contrast .col{ background:#ffffff; border-color:var(--border); }

body.theme-light .players,
body.theme-light-blue .players,
body.theme-light-mint .players,
body.theme-light-rose .players,
body.theme-light-sand .players,
body.theme-contrast .players{ background:#ffffff; }

body.theme-light .player,
body.theme-light-blue .player,
body.theme-light-mint .player,
body.theme-light-rose .player,
body.theme-light-sand .player,
body.theme-contrast .player{ background:#ffffff; border-color:#cfd6f1; color:#0f1230; }

body.theme-light .player .name,
body.theme-light .player .score,
body.theme-light-blue .player .name,
body.theme-light-blue .player .score,
body.theme-light-mint .player .name,
body.theme-light-mint .player .score,
body.theme-light-rose .player .name,
body.theme-light-rose .player .score,
body.theme-light-sand .player .name,
body.theme-light-sand .player .score,
body.theme-contrast .player .name,
body.theme-contrast .player .score{ color:#0f1230; }

body.theme-light .pill,
body.theme-light-blue .pill,
body.theme-light-mint .pill,
body.theme-light-rose .pill,
body.theme-light-sand .pill,
body.theme-contrast .pill{ background:#eef3ff; color:#2b345a; border-color:#cfd6f1; }

/* Tlaƒç√≠tka uvnit≈ô svƒõtl√Ωch t√©mat */
body.theme-light button,
body.theme-light-blue button,
body.theme-light-mint button,
body.theme-light-rose button,
body.theme-light-sand button,
body.theme-contrast button{ color:#0f1230; border-color:#cfd6f1; }

</style>
</head>
<body class="theme-dark color-keys sticky-info minimal">
<div class="wrap">
  <header>
    <div class="brand">
      <div class="brand-title">üéØ <span>≈†ipky ‚Äì zapis sk√≥re</span></div>
      <span class="pill hide-when-playing" id="statusPill">P≈ôipraveno</span>
    </div>

    <div class="activeTop" id="activeTop" role="status" aria-live="polite">
      <span class="dot"></span>
      <span id="activeTopName" style="font-weight:800"></span>
      <span class="pill" id="activeTopRemain"></span>
      <span class="pill" id="activeTopThrows"></span>
      <span class="pill" id="activeTopTip" style="display:none"></span>
      <button id="installBtnHeader" class="tab" style="margin-left:8px;display:none">Nainstalovat</button>
    </div>

    <div class="tabs hide-when-playing">
      <button class="tab active" data-tab="game">Hra</button>
      <button class="tab" data-tab="history">Historie</button>
      <button class="tab" data-tab="leaderboard">≈Ωeb≈ô√≠ƒçek</button>
      <button class="tab" data-tab="settings">Nastaven√≠</button>
      <button class="tab" id="installBtn" style="display:none">Nainstalovat</button>
    </div>
  </header>

  <section data-panel="game">
    <div class="row">
      <div class="col side">
        <h3>Hr√°ƒçi</h3>
        <div class="players" id="players"></div>
        <div class="controls" style="margin-top:10px">
          <div class="hide-when-playing" style="display:contents">
            <input id="newPlayerName" placeholder="Jm√©no hr√°ƒçe" />
            <button class="primary" id="addPlayerBtn" onclick="addPlayer()">P≈ôidat hr√°ƒçe</button>
            <button class="primary" onclick="startGameRandom()">Zaƒç√≠t hru (n√°hodnƒõ)</button>
            <button class="ghost" onclick="startNewLeg()">Zaƒç√≠t hru (aktu√°ln√≠ po≈ôad√≠)</button>
          </div>
          <button class="warn hide-during-play" onclick="startNewLeg()">Nov√© kolo (leg)</button>
          <button class="ghost" onclick="undoLastDart()">Zpƒõt posledn√≠ hod</button>
          <button class="danger" id="abortBtn" onclick="abortLeg()" title="Ukonƒçit rozehranou hru">Ukonƒçit hru</button>
        </div>
      </div>

      <div class="col grow">
        <h3>Volba hry</h3>
        <div class="chips hide-during-play" id="gameOptions" style="margin-bottom:8px">
          <label class="chip"><input type="radio" name="x01" value="101"> 101</label>
          <label class="chip"><input type="radio" name="x01" value="301"> 301</label>
          <label class="chip"><input type="radio" name="x01" value="501"> 501</label>
          <label class="chip"><input type="radio" name="x01" value="701"> 701</label>
          <label class="chip"><input type="radio" name="x01" value="901"> 901</label>
          <label class="chip"><input type="checkbox" id="doubleOut"> Double-out</label>
          <label class="chip"><input type="checkbox" id="soundToggle" checked> ƒå√≠st hodnoty</label>
        </div>

        <h3>Hody (vyber n√°sobek a hodnotu)</h3>
        <div class="chips" id="multiplier">
          <button class="chip active" data-mul="1">Single</button>
          <button class="chip" data-mul="2">Double</button>
          <button class="chip" data-mul="3">Triple</button>
        </div>
        <div class="keypad" style="margin-top:10px" id="keypad"></div>
        <div class="chips" style="margin-top:8px">
          <button class="chip" onclick="enterScore(0,1)">Chyba (0)</button>
          <button class="chip" style="outline:2px solid var(--accent2)" onclick="finishTurn()">Ukonƒçit tah</button>
        </div>
        <div class="turn small" id="turnInfo"><span class="dot"></span>Na tahu: ‚Äì</div>
        <div id="checkoutTips" class="tip small muted"></div>
      </div>

      <div class="col side hide-during-play">
        <h3>Pr≈Øbƒõh kola</h3>
        <div class="history" id="liveHistory"></div>
      </div>
    </div>
  </section>

  <section data-panel="history" hidden>
    <div class="row">
      <div class="col grow">
        <h3>Historie (v≈°e)</h3>
        <div class="history" id="fullHistory"></div>
      </div>
      <div class="col side">
        <h3>Export / Import</h3>
        <div class="controls">
          <button class="primary" onclick="downloadHistory()">St√°hnout JSON</button>
          <input type="file" id="importFile" accept="application/json"/>
          <button onclick="importHistory()">Naƒç√≠st JSON</button>
          <button class="danger" onclick="clearAll()">Smazat v≈°e</button>
        </div>
        <p class="small muted">JSON obsahuje kompletn√≠ historii (hr√°ƒçi, kola, hody, v√≠tƒõzov√©). Lze p≈ôen√©st na jin√Ω poƒç√≠taƒç.</p>
      </div>
    </div>
  </section>

  <section data-panel="leaderboard" hidden>
    <div class="col grow">
      <h3>≈Ωeb≈ô√≠ƒçek v√≠tƒõzstv√≠</h3>
      <table class="table" id="leaderTable">
        <thead><tr><th>Po≈ôad√≠</th><th>Hr√°ƒç</th><th>V√Ωhry</th></tr></thead>
        <tbody></tbody>
      </table>
      <p class="small muted">≈Ωeb≈ô√≠ƒçek se aktualizuje po ka≈æd√©m ukonƒçen√©m legu.</p>
    </div>
  </section>

  <section data-panel="settings" hidden>
    <div class="col grow">
      <h3>Vzhled &amp; rozhran√≠</h3>
      <div class="controls" style="grid-template-columns:repeat(2,minmax(0,1fr));max-width:820px">
        <label> T√©ma
          <select id="themeSelect">
            <option value="theme-dark">Tmav√© (Neon)</option>
            <option value="theme-light">Svƒõtl√©</option>
            <option value="theme-contrast">Vysok√Ω kontrast</option>
          </select>
        </label>
        <label><input type="checkbox" id="colorizeKeys" checked/> Barevnƒõ odli≈°it Single/Double/Triple</label>
        <label><input type="checkbox" id="minimalUi" checked/> Minimal UI bƒõhem hry</label>
        <label><input type="checkbox" id="stickyBarToggle" checked/> Pevn√Ω panel sk√≥re dole</label>
        <label><input type="checkbox" id="showTips" checked/> Zobrazovat checkout tipy</label>
      </div>
      <h3>Instalace jako aplikace</h3>
      <div class="chips">
        <button class="primary" id="installBtnSettings" style="display:none">Nainstalovat</button>
        <span class="small muted">Tlaƒç√≠tko se zobraz√≠, jakmile prohl√≠≈æeƒç umo≈æn√≠ instalaci (PWA).</span>
      </div>
      <p class="small muted">ƒåten√≠ hodnot je ≈ôe≈°eno <b>TTS</b> (ƒçesky). Soubory MP3 se nepou≈æ√≠vaj√≠, aby nedoch√°zelo ke konfliktu.</p>
    </div>
  </section>
</div>

<div class="stickybar" id="stickyBar">‚Äî</div>

<script>
// PWA (install)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  ['installBtn','installBtnHeader','installBtnSettings'].forEach(id=>{ const b=document.getElementById(id); if(b) b.style.display='inline-block'; });
});
window.addEventListener('appinstalled', ()=>{
  deferredPrompt = null;
  ['installBtn','installBtnHeader','installBtnSettings'].forEach(id=>{ const b=document.getElementById(id); if(b) b.style.display='none'; });
});
function doInstall(){ if(!deferredPrompt){ alert('Instalace zat√≠m nen√≠ k dispozici.'); return; } deferredPrompt.prompt(); deferredPrompt.userChoice.then(()=>{ deferredPrompt=null; }); }
['installBtn','installBtnHeader','installBtnSettings'].forEach(id=>{ const b=document.getElementById(id); if(b) b.addEventListener('click', doInstall); });

// TTS ‚Äì pouze synt√©za ≈ôeƒçi (bez MP3)
let voices=[];
function loadVoices(){ try{ voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : []; }catch(e){ voices=[]; } }
if('speechSynthesis' in window){ loadVoices(); if('onvoiceschanged' in window.speechSynthesis){ window.speechSynthesis.onvoiceschanged = loadVoices; } }
function pickCzechVoice(){ if(!voices.length) return null; const by=(c)=>voices.find(v=>v.lang && v.lang.toLowerCase().startsWith(c)); return by('cs')||by('sk')||by('pl')||voices[0]; }
function speakText(t){ if(!state.soundOn) return; if(!('speechSynthesis' in window)) return; try{ const u=new SpeechSynthesisUtterance(String(t)); const v=pickCzechVoice(); if(v) u.voice=v; u.rate=1; u.pitch=1; u.volume=1; try{ window.speechSynthesis.cancel(); }catch(e){} window.speechSynthesis.speak(u);}catch(e){} }

// Stav
const state={ startingScore:301,doubleOut:false,soundOn:true,players:[],currentIndex:0,leg:{id:ts(),turns:[]},history:loadHistory(),multiplier:1,settings:loadSettings() };
function ts(){return Date.now();}
function loadHistory(){ try{ return JSON.parse(localStorage.getItem('dartsHistoryV1'))||{players:[],legs:[]}; }catch(e){ return {players:[],legs:[]}; } }
function saveHistory(){ localStorage.setItem('dartsHistoryV1', JSON.stringify(state.history)); }
function loadSettings(){ try{ return JSON.parse(localStorage.getItem('dartsSettingsV1'))||{theme:'theme-dark',colorizeKeys:true,minimalUi:true,stickyBar:true,ttsFallback:true,showTips:true}; }catch(e){ return {theme:'theme-dark',colorizeKeys:true,minimalUi:true,stickyBar:true,ttsFallback:true,showTips:true}; } }
function saveSettings(){ localStorage.setItem('dartsSettingsV1', JSON.stringify(state.settings)); }
function loadActive(){ try{ return JSON.parse(localStorage.getItem('dartsActiveV1'))||null; }catch(e){ return null; } }
function saveActive(){ const snapshot={ startingScore:state.startingScore,doubleOut:state.doubleOut,players:state.players,currentIndex:state.currentIndex,leg:state.leg }; localStorage.setItem('dartsActiveV1', JSON.stringify(snapshot)); }
function clearActive(){ localStorage.removeItem('dartsActiveV1'); }

// Panely
const panels=document.querySelectorAll('[data-panel]');
const tabs=document.querySelectorAll('.tab[data-tab]');
for(const tab of tabs){ tab.addEventListener('click',()=>{ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); const target=tab.getAttribute('data-tab'); panels.forEach(p=>p.hidden=p.getAttribute('data-panel')!==target); if(target==='history') renderFullHistory(); if(target==='leaderboard') renderLeaderboard(); }); }
function setStatus(msg){ const el=document.getElementById('statusPill'); if(el) el.textContent=msg; }

// Hra
function isInProgress(){ return (state.leg && state.leg.turns && state.leg.turns.length>0) || state.players.some(p=>p.turnThrows && p.turnThrows.length>0); }
function addPlayer(){ if(isInProgress()){ alert('Bƒõhem hry nelze p≈ôid√°vat hr√°ƒçe.'); return; } const inp=document.getElementById('newPlayerName'); const name=(inp.value||'').trim(); if(!name) return; const id='p'+ts(); const existing=state.history.players.find(p=>p.name.toLowerCase()===name.toLowerCase()); const wins=existing? (existing.wins||0):0; const player={id,name,wins,remaining:state.startingScore,turnThrows:[]}; state.players.push(player); if(!existing) state.history.players.push({id,name,wins}); inp.value=''; renderPlayers(); saveHistory(); saveActive(); if(state.players.length===1) setStatus('P≈ôidejte dal≈°√≠ hr√°ƒçe nebo zaƒçnƒõte hru.'); }
function removePlayer(id){ if(isInProgress()){ alert('Bƒõhem hry nelze upravovat soupisku.'); return; } const idx=state.players.findIndex(p=>p.id===id); if(idx>-1){ state.players.splice(idx,1); if(state.currentIndex>=state.players.length) state.currentIndex=0; renderPlayers(); saveActive(); } }
function setGame(val){ if(isInProgress()){ alert('Nelze mƒõnit typ hry v pr≈Øbƒõhu legu.'); return; } state.startingScore=Number(val); for(const p of state.players){ p.remaining=state.startingScore; p.turnThrows=[]; } state.leg={id:ts(),turns:[]}; renderPlayers(); renderLiveHistory(); setStatus(`Nastaveno ${state.startingScore}.`); saveActive(); }
function toggleDoubleOut(on){ if(isInProgress()){ alert('Double-out lze mƒõnit jen p≈ôed legem.'); const d=document.getElementById('doubleOut'); if(d) d.checked=state.doubleOut; return;} state.doubleOut=on; setStatus(`Double-out ${on?'zapnuto':'vypnuto'}.`); saveActive(); }
function toggleSound(on){ state.soundOn=on; setStatus(`ƒåten√≠ hodnot ${on?'zapnuto':'vypnuto'}.`); saveActive(); }

function startNewLeg(){ if(state.players.length===0){ alert('P≈ôidejte alespo≈à jednoho hr√°ƒçe.'); return; } for(const p of state.players){ p.remaining=state.startingScore; p.turnThrows=[]; } state.currentIndex=0; state.leg={ id:ts(), turns:[], startingScore:state.startingScore, doubleOut:state.doubleOut, createdAt:new Date().toISOString() }; renderPlayers(); renderLiveHistory(); setStatus('Zaƒç√≠n√° nov√© kolo.'); updateUI(); saveActive(); }
function startGameRandom(){ if(state.players.length===0){ alert('P≈ôidejte alespo≈à jednoho hr√°ƒçe.'); return; }
  if(isInProgress()){ if(!confirm('Hra je rozjet√°. Ukonƒçit a zaƒç√≠t novou s n√°hodn√Ωm po≈ôad√≠m?')) return; // ulo≈æit nedokonƒçen√Ω leg
    state.history.legs.push({ ...state.leg, aborted:true }); saveHistory(); }
  // zam√≠chat po≈ôad√≠
  shuffleArray(state.players);
  // reset sk√≥re a leg
  for(const p of state.players){ p.remaining=state.startingScore; p.turnThrows=[]; }
  state.currentIndex=0;
  state.leg={ id:ts(), turns:[], startingScore:state.startingScore, doubleOut:state.doubleOut, createdAt:new Date().toISOString() };
  renderPlayers(); renderLiveHistory(); updateUI(); saveActive();
  setStatus('Zaƒç√≠n√°me ‚Äì po≈ôad√≠: '+ state.players.map(p=>p.name).join(', '));
}
function abortLeg(){ if(!isInProgress()){ alert('Nen√≠ co ukonƒçit.'); return; } if(!confirm('Ukonƒçit rozehranou hru? Rozpracovan√Ω leg bude ulo≈æen jako nedokonƒçen√Ω.')) return; state.history.legs.push({ ...state.leg, aborted:true }); saveHistory(); for(const p of state.players){ p.remaining=state.startingScore; p.turnThrows=[]; } state.currentIndex=0; state.leg={ id:ts(), turns:[], startingScore:state.startingScore, doubleOut:state.doubleOut, createdAt:new Date().toISOString() }; renderPlayers(); renderLiveHistory(); updateUI(); saveActive(); setStatus('Hra ukonƒçena.'); }
function currentPlayer(){ return state.players[state.currentIndex]; }
function nextPlayer(){ state.currentIndex=(state.currentIndex+1)%state.players.length; }

// Zvuk ‚Äì TTS only
function playNumber(n){ speakText(n); }
function playWord(word){ speakText(word==='vyhra' ? 'V√Ωhra' : (word==='bust' ? 'Bust' : word)); }

// Zad√°v√°n√≠ hod≈Ø
function enterScore(base,mul){ mul=mul||state.multiplier; const player=currentPlayer(); if(!player){ alert('≈Ω√°dn√≠ hr√°ƒçi.'); return; } const score=base*mul; if(state.soundOn){ playNumber(score); }
  if(!player.turnThrows) player.turnThrows=[]; if(player.turnThrows.length>=3){ finishTurn(); return; }
  player.turnThrows.push({base,mul,score}); renderPlayers(); renderLiveHistory(); renderTips();
  if(player.turnThrows.length===3){ finishTurn(); }
  state.multiplier=1; document.querySelectorAll('#multiplier .chip').forEach(c=>c.classList.remove('active')); const sbtn=document.querySelector('#multiplier .chip[data-mul="1"]'); if(sbtn) sbtn.classList.add('active');
  updateUI(); saveActive(); }

function finishTurn(){ const player=currentPlayer(); if(!player) return; const darts=player.turnThrows||[]; if(darts.length===0){ nextPlayer(); renderPlayers(); saveActive(); return; }
  const turnTotal=darts.reduce((a,d)=>a+d.score,0); let remaining=player.remaining - turnTotal; let bust=false;
  if (typeof updateTurnInfo === 'function') updateTurnInfo();
if (typeof updateSticky    === 'function') updateSticky();
if (typeof updateTopBar    === 'function') updateTopBar();
if (typeof renderTips      === 'function') renderTips();
  if(remaining<0){ bust=true; remaining=player.remaining; } else if(remaining===0){ if(state.doubleOut){ const last=darts[darts.length-1]; if(last.mul!==2){ bust=true; remaining=player.remaining; } } } else if(state.doubleOut && remaining===1){ bust=true; remaining=player.remaining; }
  if(!bust){ player.remaining=remaining; }
  const record={ playerId:player.id, playerName:player.name, darts:deepClone(darts), turnTotal, bust, remainingAfter:player.remaining, when:new Date().toISOString() };
  state.leg.turns.push(record);
  if(state.soundOn){ if(bust){ playWord('bust'); } else if(false){ playNumber(turnTotal); } }
  if(player.remaining===0){ playWord('vyhra'); const winnerId=player.id; state.history.legs.push({ ...state.leg, winnerId }); const hp=state.history.players.find(p=>p.id===player.id); if(hp){ hp.wins=(hp.wins||0)+1; } saveHistory(); alert(`V√≠tƒõz: ${player.name}!`); setStatus(`V√≠tƒõz: ${player.name}`); startNewLeg(); renderLeaderboard(); updateUI(); saveActive(); return; }
  player.turnThrows=[]; nextPlayer(); renderPlayers(); renderLiveHistory(); updateTurnInfo(); saveHistory(); updateUI(); saveActive(); renderTips(); }

function undoLastDart(){ const p=currentPlayer(); if(p && p.turnThrows && p.turnThrows.length>0){ p.turnThrows.pop(); renderPlayers(); renderLiveHistory(); updateUI(); renderTips(); saveActive(); return; } const last=state.leg.turns[state.leg.turns.length-1]; if(!last){ setStatus('Nic k vr√°cen√≠.'); return; } const idx=state.players.findIndex(pl=>pl.id===last.playerId); if(idx!==-1) state.currentIndex=idx; const pl=currentPlayer(); pl.remaining= last.bust? pl.remaining : last.remainingAfter + last.turnTotal; pl.turnThrows=last.darts; state.leg.turns.pop(); renderPlayers(); renderLiveHistory(); updateUI(); renderTips(); saveActive(); }

// Checkout tipy
const UNFINISHABLE=new Set([169,168,166,165,163,162,159]);
const TPR=[20,19,18,17,16,15];
function suggestDoubleOut(rem){ const res=[]; if(rem>170||rem<=1||UNFINISHABLE.has(rem)) return res; if(rem===50) return [['D25']]; if(rem%2===0 && rem<=40) return [[`D${rem/2}`]]; for(const t of TPR){ const r=rem-3*t; if(r===50){ res.push([`T${t}`, 'D25']); break; } if(r>0 && r%2===0 && r<=40){ res.push([`T${t}`, `D${r/2}`]); if(res.length>=3) break; } } if(res.length>=3) return res; outer: for(const t of TPR){ for(let s=20;s>=1;s--){ const r=rem-3*t - s; if(r===50){ res.push([`T${t}`, `S${s}`, 'D25']); } else if(r>0 && r%2===0 && r<=40){ res.push([`T${t}`, `S${s}`, `D${r/2}`]); } if(res.length>=3) break outer; } } if(res.length>=3) return res; for(const t1 of TPR){ for(const t2 of TPR){ const r=rem-3*t1-3*t2; if(r===50){ res.push([`T${t1}`,`T${t2}`,'D25']); } else if(r>0 && r%2===0 && r<=40){ res.push([`T${t1}`,`T${t2}`,`D${r/2}`]); } if(res.length>=3) break; } if(res.length>=3) break; } return res; }
function suggestSingleOut(rem){ const res=[]; if(rem<=0) return res; if(rem<=50){ if(rem===50) return [['Bull']]; return [[`S${rem}`]]; } for(const t of TPR){ const r=rem-3*t; if(r>=0 && r<=50){ if(r===50) res.push([`T${t}`, 'Bull']); else res.push([`T${t}`, `S${r}`]); if(res.length>=3) break; } } if(!res.length){ for(const t of TPR){ const r=rem-3*t; const targets=[40,32,24,16,8,2,50]; for(const d of targets){ const s=r-d; if(s>=0 && s<=20){ res.push([`T${t}`, `S${s}`, (d===50?'Bull':`S${d}`)]); break; } } if(res.length) break; } } return res; }
function getProjectedRemaining(p){ const used=(p.turnThrows||[]).reduce((a,d)=>a+d.score,0); return p.remaining - used; }
function renderTips(){ const box=document.getElementById('checkoutTips'); const tipPill=document.getElementById('activeTopTip'); const showOpt=document.getElementById('showTips'); if(!box) return; const showTips = showOpt ? showOpt.checked : true; if(!showTips){ box.textContent=''; if(tipPill) tipPill.style.display='none'; return; } const p=currentPlayer(); if(!p){ box.textContent=''; if(tipPill) tipPill.style.display='none'; return; } const proj=getProjectedRemaining(p); const limit = state.doubleOut ? 170 : 120; if(proj<=0 || proj>limit || UNFINISHABLE.has(proj)){ box.textContent=''; if(tipPill) tipPill.style.display='none'; return; } const tips = state.doubleOut? suggestDoubleOut(proj): suggestSingleOut(proj); if(!tips.length){ box.textContent=''; if(tipPill) tipPill.style.display='none'; return; } const strings=tips.map(arr=>arr.join(' ‚Üí ')); const text='Tipy: '+strings.join(' | '); box.textContent = text; if(tipPill){ tipPill.textContent = strings[0]; tipPill.style.display='inline-block'; } }

// Renderov√°n√≠
function renderPlayers(){
  var box = document.getElementById('players');
  if(!box) return;

  // vypr√°zdnit kontejner
  box.innerHTML = '';

  for (var i=0; i<state.players.length; i++){
    (function(i){
      var p = state.players[i];

      var throwsTxt = (p.turnThrows && p.turnThrows.length)
        ? ' [' + p.turnThrows.map(formatDartShort).join(', ') + ']'
        : '';

      // ≈ô√°dek hr√°ƒçe
      var row = document.createElement('div');
      row.className = 'player';
      row.setAttribute('data-id', p.id);

      // lev√° ƒç√°st (po≈ôad√≠ + jm√©no)
      var left = document.createElement('div');
      left.style.display = 'flex';
      left.style.alignItems = 'center';
      left.style.gap = '8px';

      var pill = document.createElement('div');
      pill.className = 'pill';
      if(i === state.currentIndex) pill.style.outline = '2px solid var(--accent)';
      pill.textContent = (i===state.currentIndex ? '‚ñ∂Ô∏è ' : '') + (i+1);

      var name = document.createElement('div');
      name.className = 'name';
      name.textContent = p.name + (throwsTxt ? ' ' + throwsTxt : '');

      left.appendChild(pill);
      left.appendChild(name);

      // prav√° ƒç√°st (sk√≥re + odebrat)
      var right = document.createElement('div');
      right.style.display = 'flex';
      right.style.alignItems = 'center';
      right.style.gap = '8px';

      var score = document.createElement('div');
      score.className = 'score';
      score.textContent = p.remaining;

      var remove = document.createElement('button');
      remove.className = 'ghost';
      remove.title = 'Odebrat';
      remove.textContent = '‚úñ';
      remove.addEventListener('click', (function(id){
        return function(){ removePlayer(id); };
      })(p.id));

      right.appendChild(score);
      right.appendChild(remove);

      row.appendChild(left);
      row.appendChild(right);
      box.appendChild(row);
    })(i);
  }

  updateTurnInfo();
  updateSticky();
  updateTopBar();
  renderTips();
}


function updateSticky(){
  const bar=document.getElementById('stickyBar'); if(!bar) return;
  const p=currentPlayer();
  const throwTxt=p && p.turnThrows && p.turnThrows.length ? p.turnThrows.map(formatDartShort).join(', ') : '‚Äî';
  bar.innerHTML = p ? `Na tahu: <b>${escapeHtml(p.name)}</b> ‚Ä¢ Zb√Ωv√°: <b>${p.remaining}</b> ‚Ä¢ Hody: ${throwTxt}` : '‚Äî';
}
function updateTopBar(){
  const top=document.getElementById('activeTop'); if(!top) return;
  const playing=isInProgress(); top.style.display=playing?'flex':'none'; if(!playing) return;
  const p=currentPlayer();
  document.getElementById('activeTopName').textContent = p ? p.name : '‚Äî';
  document.getElementById('activeTopRemain').textContent = p ? ('Zb√Ωv√°: '+p.remaining) : '';
  const throwTxt = p && p.turnThrows && p.turnThrows.length ? p.turnThrows.map(formatDartShort).join(', ') : '‚Äî';
  document.getElementById('activeTopThrows').textContent = 'Hody: '+throwTxt;
}
function formatDart(d){ const m=d.mul===1?'S':(d.mul===2?'D':'T'); return `${m}${d.base}=${d.score}`; }
function formatDartShort(d){ const m=d.mul===1?'S':(d.mul===2?'D':'T'); return `${m}${d.base}`; }
function escapeHtml(s){ s = (s+""); return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Vzhled
function applySettings(){ document.body.classList.remove('theme-dark','theme-light','theme-contrast'); document.body.classList.add(state.settings.theme); document.body.classList.toggle('color-keys', !!state.settings.colorizeKeys); document.body.classList.toggle('minimal', !!state.settings.minimalUi); document.body.classList.toggle('sticky-info', !!state.settings.stickyBar); const ttsEl=document.getElementById('ttsFallback'); if(ttsEl) ttsEl.checked= state.settings.ttsFallback!==false; const tipsEl=document.getElementById('showTips'); if(tipsEl) tipsEl.checked= state.settings.showTips!==false; updateUI(); }
function bindSettingsUI(){ const sel=document.getElementById('themeSelect'); if(sel){ sel.value=state.settings.theme; sel.onchange=()=>{ state.settings.theme=sel.value; saveSettings(); applySettings(); saveActive(); }; }
  const ck1=document.getElementById('colorizeKeys'); if(ck1){ ck1.checked=!!state.settings.colorizeKeys; ck1.onchange=()=>{ state.settings.colorizeKeys=ck1.checked; saveSettings(); applySettings(); saveActive(); }; }
  const ck2=document.getElementById('minimalUi'); if(ck2){ ck2.checked=!!state.settings.minimalUi; ck2.onchange=()=>{ state.settings.minimalUi=ck2.checked; saveSettings(); applySettings(); saveActive(); }; }
  const ck3=document.getElementById('stickyBarToggle'); if(ck3){ ck3.checked=!!state.settings.stickyBar; ck3.onchange=()=>{ state.settings.stickyBar=ck3.checked; saveSettings(); applySettings(); saveActive(); }; }
  const ck4=document.getElementById('ttsFallback'); if(ck4){ ck4.checked= state.settings.ttsFallback!==false; ck4.onchange=()=>{ state.settings.ttsFallback=ck4.checked; saveSettings(); }; }
  const ck5=document.getElementById('showTips'); if(ck5){ ck5.checked= state.settings.showTips!==false; ck5.onchange=()=>{ state.settings.showTips=ck5.checked; saveSettings(); renderTips(); }; }
}

// Game options
function bindGameOptions(){ const box=document.getElementById('gameOptions'); if(!box) return; box.addEventListener('change',(e)=>{ const t=e.target; if(!t || !t.tagName) return; if(t.tagName==='INPUT'){ const id=t.id||''; if(t.name==='x01'){ setGame(Number(t.value)); syncGameOptionsUI(); } else if(id==='doubleOut'){ toggleDoubleOut(t.checked); } else if(id==='soundToggle'){ toggleSound(t.checked); } } }); }
function syncGameOptionsUI(){ const cur=String(state.startingScore); document.querySelectorAll('input[name="x01"]').forEach(r=>{ r.checked = (r.value===cur); }); const d=document.getElementById('doubleOut'); if(d) d.checked=!!state.doubleOut; const s=document.getElementById('soundToggle'); if(s) s.checked=!!state.soundOn; }

// Utility
function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
function deepClone(o){ try{ return (typeof structuredClone==='function') ? structuredClone(o) : JSON.parse(JSON.stringify(o)); } catch(e){ return JSON.parse(JSON.stringify(o)); } }

function updateUI(){ document.body.classList.toggle('playing', isInProgress()); togglePlayerControls(isInProgress()); updateSticky(); updateTopBar(); renderTips(); }
function updateTurnInfo(){
  var el = document.getElementById('turnInfo');
  var p  = currentPlayer ? currentPlayer() : null;
  if (!el) return;
  el.innerHTML = p
    ? 'Na tahu: <b>'+escapeHtml(p.name)+'</b> ‚Ä¢ Zb√Ωv√°: '+p.remaining
    : 'Na tahu: ‚Äì';
}

function updateSticky(){
  var el = document.getElementById('stickyBar'); if (!el) return;
  var p  = currentPlayer ? currentPlayer() : null;
  var throwsTxt = (p && p.turnThrows && p.turnThrows.length)
      ? p.turnThrows.map(formatDartShort).join(', ')
      : '‚Äî';
  el.innerHTML = p
    ? 'Na tahu: <b>'+escapeHtml(p.name)+'</b> ‚Ä¢ Zb√Ωv√°: <b>'+p.remaining+'</b> ‚Ä¢ Hody: '+throwsTxt
    : '‚Äî';
}

function updateTopBar(){
  var top = document.getElementById('activeTop'); if (!top) return;
  var playing = isInProgress && isInProgress();
  top.style.display = playing ? 'flex' : 'none';
  if (!playing) return;

  var p = currentPlayer ? currentPlayer() : null;
  var tname = document.getElementById('activeTopName');
  var trem  = document.getElementById('activeTopRemain');
  var tthr  = document.getElementById('activeTopThrows');

  if (tname) tname.textContent = p ? p.name : '‚Äî';
  if (trem)  trem.textContent  = p ? ('Zb√Ωv√°: '+p.remaining) : '';
  if (tthr)  tthr.textContent  = 'Hody: ' + ((p && p.turnThrows && p.turnThrows.length)
                      ? p.turnThrows.map(formatDartShort).join(', ')
                      : '‚Äî');
}

function togglePlayerControls(disabled){
  var inp = document.getElementById('newPlayerName');
  var btn = document.getElementById('addPlayerBtn');
  if (inp){ inp.disabled = disabled; inp.placeholder = disabled ? 'Nelze bƒõhem hry' : 'Jm√©no hr√°ƒçe'; }
  if (btn){ btn.disabled = disabled; }
}

function updateUI(){
  var playing = isInProgress && isInProgress();
  document.body.classList.toggle('playing', !!playing);
  togglePlayerControls(!!playing);
  updateSticky();
  updateTopBar();
  if (typeof renderTips === 'function') renderTips();
}

// Init
function buildKeypad(){ const pad=document.getElementById('keypad'); pad.innerHTML=''; const nums=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,25,50]; nums.forEach(n=>{ const b=document.createElement('button'); b.className='key'; b.textContent=n; b.addEventListener('click',()=>enterScore(n)); pad.appendChild(b); }); const miss=document.createElement('button'); miss.className='key miss'; miss.textContent='Miss'; miss.addEventListener('click',()=>enterScore(0,1)); pad.appendChild(miss); }
// Fallback pro prohl√≠≈æeƒçe, kde inline onclick neprojde:
(function bindAddPlayer(){
  var btn = document.getElementById('addPlayerBtn');
  var inp = document.getElementById('newPlayerName');
  if (btn) btn.addEventListener('click', function(e){ e.preventDefault(); addPlayer(); });
  if (inp) inp.addEventListener('keydown', function(e){ if (e.key==='Enter') addPlayer(); });
})();
function setupMultiplierChips(){ const box=document.getElementById('multiplier'); box.querySelectorAll('.chip').forEach(ch=>{ ch.addEventListener('click',()=>{ box.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); ch.classList.add('active'); state.multiplier=Number(ch.dataset.mul); saveActive(); }); }); }
  
buildKeypad(); setupMultiplierChips(); bindGameOptions(); renderPlayers(); renderLiveHistory(); updateTurnInfo(); applySettings(); bindSettingsUI(); syncGameOptionsUI();
const saved=loadActive(); if(saved && saved.players && saved.players.length){ state.startingScore=saved.startingScore??state.startingScore; state.doubleOut=!!saved.doubleOut; state.players=saved.players; state.currentIndex=saved.currentIndex||0; state.leg=saved.leg||state.leg; renderPlayers(); renderLiveHistory(); updateTurnInfo(); syncGameOptionsUI(); }
updateUI();
window.addPlayer       = addPlayer;
window.startGameRandom = startGameRandom;
window.startNewLeg     = startNewLeg;
window.abortLeg        = abortLeg;
window.undoLastDart    = undoLastDart;
window.enterScore      = enterScore;
window.finishTurn      = finishTurn;
function togglePlayerControls(disabled){
  var inp = document.getElementById('newPlayerName');
  var btn = document.getElementById('addPlayerBtn');
  if (inp) { inp.disabled = disabled; inp.placeholder = disabled ? 'Nelze bƒõhem hry' : 'Jm√©no hr√°ƒçe'; }
  if (btn) { btn.disabled = disabled; }
}

</script>
</body>
</html>
