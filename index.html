<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>≈†ipky ‚Äì zapis sk√≥re</title>
  <meta name="theme-color" content="#0b0e1a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root{
      --bg1:#0b0e1a; --bg2:#12152a; --fg:#e8ebf8; --muted:#aeb3c7;
      --card:#171a2b; --border:#2d3353; --accent:#6ee7ff; --accent2:#9bff6e;
      --danger:#ff6e6e; --warn:#ffd56e; --shadow:0 10px 30px rgba(0,0,0,.35);
      --mul1:#0f142f; --mul2:#10321f; --mul3:#3a1a12;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2) 40%,var(--bg1));color:var(--fg);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 110px}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg1) 90%,rgba(0,0,0,0));backdrop-filter:saturate(120%) blur(4px);display:flex;gap:12px;align-items:center;justify-content:space-between;margin:0 0 10px;padding:8px 0 10px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-title{font-weight:800;letter-spacing:.3px;font-size:20px}
    .pill{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:6px 10px;color:var(--muted)}
    .tabs{display:flex;gap:6px}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0e1229;cursor:pointer}
    .tab.active{outline:2px solid var(--accent)}

    /* horn√≠ pruh aktivn√≠ho hr√°ƒçe ‚Äì lep≈°√≠ ƒçitelnost */
    .activeTop{display:none;align-items:center;gap:12px;padding:10px 12px;border-radius:16px;border:3px solid var(--accent);
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      box-shadow:0 0 0 3px rgba(110,231,255,0.2), 0 6px 20px rgba(0,0,0,0.35)}
    .activeTop .dot{width:14px;height:14px;border-radius:50%;background:var(--accent2);box-shadow:0 0 16px var(--accent2)}
    #activeTopName{font-size:22px;font-weight:900;letter-spacing:.3px;text-transform:uppercase}
    #activeTopRemain, #activeTopThrows{font-size:16px}
    body.playing .brand{display:none}
    body.playing .activeTop{display:flex}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
    .col h3{margin:6px 0 12px;font-size:16px}
    .grow{flex:1 1 360px}
    .side{flex:0 1 320px}

    .controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
    input,button,select{background:#0e1121;color:var(--fg);border:1px solid var(--border);border-radius:12px;padding:10px 12px;font:inherit}
    button{cursor:pointer;transition:transform .05s ease}
    button:hover{transform:translateY(-1px)}
    button.primary{background:linear-gradient(180deg,#1a2a5a,#15224a);border-color:#35407a}
    button.warn{background:#402b00;border-color:#6d4a00}
    button.danger{background:#3a0b0b;border-color:#652828}
    button.ghost{background:transparent}

    .players{display:flex;flex-direction:column;gap:8px}
    .player{display:flex;align-items:center;gap:8px;justify-content:space-between;background:#121634;border:1px solid var(--border);border-radius:12px;padding:10px}
    .player .name{font-weight:700}
    .player .score{font-variant-numeric:tabular-nums;font-size:18px}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#0f142f;cursor:pointer;user-select:none}
    .chip.active{outline:2px solid var(--accent)}

    .keypad{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .key{padding:14px 0;text-align:center;border-radius:12px;border:1px solid var(--border);background:#101431;font-weight:800;font-size:18px}
    .key.miss{background:#2a1420}

    .history{max-height:340px;overflow:auto;border-radius:12px;border:1px solid var(--border);background:#0b0e1f}
    .hist-row{padding:8px 12px;border-bottom:1px solid #242a4a}
    .hist-row:last-child{border-bottom:none}
    .small{font-size:12px}.muted{color:var(--muted)}

    .stickybar{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:rgba(0,0,0,.65);color:#fff;border-top:1px solid var(--border)}
    @media (max-width: 800px){
      .controls{grid-template-columns:repeat(2,minmax(0,1fr))}
      .side{flex:1 1 100%}.grow{flex:1 1 100%}
      .keypad{grid-template-columns:repeat(5,1fr)} .key{padding:16px 0;font-size:20px}
      .tabs{flex-wrap:wrap}
    }
    @media (max-width: 480px){ .keypad{grid-template-columns:repeat(4,1fr)} }
    /* Svƒõtl√° t√©mata (v√≠ce variant) */
body.theme-light{
  --bg1:#f6f8ff; --bg2:#e9eefb; --fg:#0f1230; --muted:#4b5070;
  --card:#ffffff; --border:#cfd6f1; --accent:#1e60ff; --accent2:#0fb66f;
  --danger:#e54747; --warn:#d9a000; --mul1:#eef2ff; --mul2:#e6fff0; --mul3:#fff0ea;
}
/* vysok√Ω kontrast (svƒõtl√Ω) */
body.theme-contrast{
  --bg1:#ffffff; --bg2:#ffffff; --fg:#000000; --muted:#222;
  --card:#ffffff; --border:#000000; --accent:#0000ff; --accent2:#00aa00;
  --danger:#ff0000; --warn:#ff9900; --mul1:#f2f2f2; --mul2:#e8fff0; --mul3:#ffeaea;
}
/* modr√° svƒõtl√° */
body.theme-light-blue{
  --bg1:#eef6ff; --bg2:#e4f0ff; --fg:#0b1630; --muted:#3b4a6a;
  --card:#ffffff; --border:#b9d1ff; --accent:#2b6bff; --accent2:#0fb66f;
  --danger:#e54747; --warn:#d9a000; --mul1:#eaf2ff; --mul2:#e9fff3; --mul3:#fff0f2;
}
/* m√°tov√° svƒõtl√° */
body.theme-light-mint{
  --bg1:#f0fff7; --bg2:#e6fff1; --fg:#0b3020; --muted:#2d6a52;
  --card:#ffffff; --border:#bfead6; --accent:#0aa86f; --accent2:#1e60ff;
  --danger:#e54747; --warn:#d9a000; --mul1:#effaf5; --mul2:#e6fff1; --mul3:#fff0ea;
}
/* r≈Ø≈æov√° svƒõtl√° */
body.theme-light-rose{
  --bg1:#fff2f6; --bg2:#ffe8f0; --fg:#30101b; --muted:#6a2d45;
  --card:#ffffff; --border:#ffb9cf; --accent:#e43d6f; --accent2:#0fb66f;
  --danger:#d12b4a; --warn:#d9a000; --mul1:#fff0f6; --mul2:#f0fff6; --mul3:#fff4ef;
}
/* p√≠skov√° svƒõtl√° */
body.theme-light-sand{
  --bg1:#fffaf0; --bg2:#fff4dc; --fg:#302410; --muted:#6a5a2d;
  --card:#ffffff; --border:#f0e0b9; --accent:#ff8a00; --accent2:#1d7a4a;
  --danger:#d33; --warn:#c80; --mul1:#fff6e5; --mul2:#eeffe8; --mul3:#fff0ea;
}

  </style>
</head>
<body class="theme-dark sticky-info">
<div class="wrap">
  <header>
    <div class="brand">
      <div class="brand-title">üéØ <span>≈†ipky ‚Äì zapis sk√≥re</span></div>
      <span class="pill" id="statusPill">P≈ôipraveno</span>
    </div>
    <div class="activeTop" id="activeTop" role="status" aria-live="polite">
      <span class="dot"></span>
      <span id="activeTopName"></span>
      <span class="pill" id="activeTopRemain"></span>
      <span class="pill" id="activeTopThrows"></span>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="game">Hra</button>
      <button class="tab" data-tab="history">Historie</button>
      <button class="tab" data-tab="leaderboard">≈Ωeb≈ô√≠ƒçek</button>
      <button class="tab" data-tab="settings">Nastaven√≠</button>
    </div>
  </header>

  <!-- GAME -->
  <section data-panel="game">
    <div class="row">
      <div class="col side">
        <h3>Hr√°ƒçi</h3>
        <div class="players" id="players"></div>
        <div class="controls" style="margin-top:10px">
          <input id="newPlayerName" placeholder="Jm√©no hr√°ƒçe" />
          <button class="primary" onclick="addPlayer()">P≈ôidat hr√°ƒçe</button>
          <button class="primary" onclick="startGameRandom()">Zaƒç√≠t hru (n√°hodnƒõ)</button>
          <button class="ghost"   onclick="startNewLeg()">Zaƒç√≠t hru (aktu√°ln√≠ po≈ôad√≠)</button>
          <button class="warn"   onclick="startNewLeg()">Nov√© kolo (leg)</button>
          <button class="ghost"  onclick="undoLastDart()">Zpƒõt posledn√≠ hod</button>
          <button class="danger" onclick="abortLeg()">Ukonƒçit hru</button>
        </div>
      </div>

      <div class="col grow">
        <h3>Volba hry</h3>
        <div class="chips" id="gameOptions" style="margin-bottom:8px">
          <label class="chip"><input type="radio" name="x01" value="101"> 101</label>
          <label class="chip"><input type="radio" name="x01" value="301" checked> 301</label>
          <label class="chip"><input type="radio" name="x01" value="501"> 501</label>
          <label class="chip"><input type="radio" name="x01" value="701"> 701</label>
          <label class="chip"><input type="radio" name="x01" value="901"> 901</label>
          <label class="chip"><input type="checkbox" id="doubleOut"> Double-out</label>
          <label class="chip"><input type="checkbox" id="soundToggle" checked> ƒå√≠st hodnoty</label>
        </div>

        <h3>Hody (vyber n√°sobek a hodnotu)</h3>
        <div class="chips" id="multiplier">
          <button class="chip active" data-mul="1">Single</button>
          <button class="chip" data-mul="2">Double</button>
          <button class="chip" data-mul="3">Triple</button>
        </div>
        <div class="keypad" style="margin-top:10px" id="keypad"></div>
        <div class="chips" style="margin-top:8px">
          <button class="chip" onclick="enterScore(0,1)">Chyba (0)</button>
          <button class="chip" style="outline:2px solid var(--accent2)" onclick="finishTurn()">Ukonƒçit tah</button>
        </div>
        <div class="small muted" id="turnInfo">Na tahu: ‚Äì</div>
        <div id="checkoutTips" class="small muted" style="margin-top:6px"></div>
      </div>

      <div class="col side">
        <h3>Pr≈Øbƒõh kola</h3>
        <div class="history" id="liveHistory"></div>
      </div>
    </div>
  </section>

  <!-- HISTORY -->
  <section data-panel="history" hidden>
    <div class="row">
      <div class="col grow">
        <h3>Historie (v≈°e)</h3>
        <div class="history" id="fullHistory"></div>
      </div>
      <div class="col side">
        <h3>Export / Import</h3>
        <div class="controls">
          <button class="primary" onclick="downloadHistory()">St√°hnout JSON</button>
          <input type="file" id="importFile" accept="application/json"/>
          <button onclick="importHistory()">Naƒç√≠st JSON</button>
          <button class="danger" onclick="clearAll()">Smazat v≈°e</button>
        </div>
      </div>
    </div>
  </section>

  <!-- LEADERBOARD -->
  <section data-panel="leaderboard" hidden>
    <div class="col grow">
      <h3>≈Ωeb≈ô√≠ƒçek v√≠tƒõzstv√≠</h3>
      <table class="table" id="leaderTable" style="width:100%;border-collapse:collapse">
        <thead><tr><th>Po≈ôad√≠</th><th>Hr√°ƒç</th><th>V√Ωhry</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- SETTINGS -->
  <section data-panel="settings" hidden>
  <div class="col grow">
    <h3>Nastaven√≠</h3>
    <div class="controls" style="grid-template-columns:repeat(2,minmax(0,1fr));max-width:820px">
      <label> T√©ma vzhledu
        <select id="themeSelect">
          <option value="theme-dark">Tmav√© (v√Ωchoz√≠)</option>
          <option value="theme-light">Svƒõtl√© ‚Äì klasick√©</option>
          <option value="theme-light-blue">Svƒõtl√© ‚Äì modr√©</option>
          <option value="theme-light-mint">Svƒõtl√© ‚Äì m√°tov√©</option>
          <option value="theme-light-rose">Svƒõtl√© ‚Äì r≈Ø≈æov√©</option>
          <option value="theme-light-sand">Svƒõtl√© ‚Äì p√≠skov√©</option>
          <option value="theme-contrast">Svƒõtl√© ‚Äì vysok√Ω kontrast</option>
        </select>
      </label>
      <label><input type="checkbox" id="showTips" checked/> Zobrazovat checkout tipy</label>
    </div>
    <p class="small muted">Volba t√©matu se ulo≈æ√≠ do prohl√≠≈æeƒçe. ƒåten√≠ hodnot je ≈ôe≈°eno <b>TTS</b> (ƒçesky) ‚Äì bez MP3.</p>
  </div>
</section>

</div>

<div class="stickybar" id="stickyBar" role="status" aria-live="polite">‚Äî</div>

<script>
  // T√©mata ‚Äì ulo≈æen√≠ a aplikace
var THEME_KEY='dartsThemeV1';
var THEME_CLASSES=['theme-dark','theme-light','theme-light-blue','theme-light-mint','theme-light-rose','theme-light-sand','theme-contrast'];
function loadTheme(){ try{ return localStorage.getItem(THEME_KEY) || 'theme-dark'; }catch(e){ return 'theme-dark'; } }
function saveTheme(cls){ try{ localStorage.setItem(THEME_KEY, cls); }catch(e){} }
function applyTheme(cls){ var b=document.body; for(var i=0;i<THEME_CLASSES.length;i++){ b.classList.remove(THEME_CLASSES[i]); } b.classList.add(cls); }
function bindThemeUI(){ var sel=document.getElementById('themeSelect'); if(!sel) return; sel.value=loadTheme(); sel.onchange=function(){ var v=sel.value; applyTheme(v); saveTheme(v); }; }

/* ====== PWA registrace ====== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function(){
    navigator.serviceWorker.register('./sw.js').then(function(reg){
      if (reg && reg.update) reg.update();
      setInterval(function(){ if (reg && reg.update) reg.update(); }, 3600000);
    }).catch(function(){});
    navigator.serviceWorker.addEventListener('controllerchange', function(){
      if (!window._reloadedForSW){ window._reloadedForSW=true; location.reload(); }
    });
  });
}

/* ====== TTS (jen hlas) ====== */
var voices=[];
function loadVoices(){ try{ voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : []; }catch(e){ voices=[]; } }
if('speechSynthesis' in window){
  loadVoices();
  if('onvoiceschanged' in window.speechSynthesis){ window.speechSynthesis.onvoiceschanged = loadVoices; }
}
function pickCzechVoice(){ if(!voices.length) return null; function by(c){ return voices.find(function(v){ return v.lang && v.lang.toLowerCase().indexOf(c)===0; }); } return by('cs')||by('sk')||by('pl')||voices[0]; }
function speakText(t){
  if(!state.soundOn) return;
  if(!('speechSynthesis' in window)) return;
  try{
    var u=new SpeechSynthesisUtterance(String(t));
    var v=pickCzechVoice(); if(v) u.voice=v;
    u.rate=1; u.pitch=1; u.volume=1;
    try{ window.speechSynthesis.cancel(); }catch(e){}
    window.speechSynthesis.speak(u);
  }catch(e){}
}
function playNumber(n){ speakText(n); }
function playWord(w){ speakText(w==='vyhra'?'V√Ωhra':(w==='bust'?'Bust':w)); }

/* ====== Stav a √∫lo≈æi≈°tƒõ ====== */
var state={
  startingScore:301,
  doubleOut:false,
  soundOn:true,
  players:[], // {id,name,wins,remaining,turnThrows:[]}
  currentIndex:0,
  leg:{ id:ts(), turns:[], startingScore:301, doubleOut:false, createdAt:new Date().toISOString() },
  history: loadHistory(),
  multiplier:1
};
function ts(){return Date.now();}
function deepClone(o){ try{ return (typeof structuredClone==='function')? structuredClone(o) : JSON.parse(JSON.stringify(o)); }catch(e){ return JSON.parse(JSON.stringify(o)); } }
function loadHistory(){ try{ return JSON.parse(localStorage.getItem('dartsHistoryV1')) || {players:[],legs:[]}; } catch(e){ return {players:[],legs:[]}; } }
function saveHistory(){ localStorage.setItem('dartsHistoryV1', JSON.stringify(state.history)); }
function loadActive(){ try{ return JSON.parse(localStorage.getItem('dartsActiveV1')) || null; }catch(e){ return null; } }
function saveActive(){ var snap={ startingScore:state.startingScore,doubleOut:state.doubleOut,players:state.players,currentIndex:state.currentIndex,leg:state.leg,soundOn:state.soundOn }; localStorage.setItem('dartsActiveV1', JSON.stringify(snap)); }

/* ====== UI panely ====== */
var panels=document.querySelectorAll('[data-panel]');
Array.prototype.forEach.call(document.querySelectorAll('.tab[data-tab]'), function(tab){
  tab.addEventListener('click', function(){
    Array.prototype.forEach.call(document.querySelectorAll('.tab'), function(t){ t.classList.remove('active'); });
    tab.classList.add('active');
    var target=tab.getAttribute('data-tab');
    Array.prototype.forEach.call(panels, function(p){ p.hidden = p.getAttribute('data-panel')!==target; });
    if(target==='history') renderFullHistory();
    if(target==='leaderboard') renderLeaderboard();
  });
});
function setStatus(msg){ var el=document.getElementById('statusPill'); if(el) el.textContent=msg; }

/* ====== Logika hry ====== */
function isInProgress(){
  return (state.leg && state.leg.turns && state.leg.turns.length>0)
      || state.players.some(function(p){ return p.turnThrows && p.turnThrows.length>0; });
}
function addPlayer(){
  var inp=document.getElementById('newPlayerName');
  var name=(inp.value||'').trim();
  if(!name) return;
  var id='p'+ts();
  var existing=(state.history.players||[]).find(function(p){ return (p.name||'').toLowerCase()===name.toLowerCase(); });
  var wins=existing? (existing.wins||0) : 0;
  var player={id:id,name:name,wins:wins,remaining:state.startingScore,turnThrows:[]};
  state.players.push(player);
  if(!existing){ (state.history.players=state.history.players||[]).push({id:id,name:name,wins:wins}); }
  inp.value='';
  renderPlayers(); saveHistory(); saveActive();
  if(state.players.length===1) setStatus('P≈ôidejte dal≈°√≠ hr√°ƒçe nebo zaƒçnƒõte hru.');
}
function removePlayer(id){
  if(isInProgress()){ alert('Bƒõhem hry nelze upravovat soupisku.'); return; }
  var i=state.players.findIndex(function(p){ return p.id===id; });
  if(i>-1){ state.players.splice(i,1); if(state.currentIndex>=state.players.length) state.currentIndex=0; renderPlayers(); saveActive(); }
}
function setGame(val){
  if(isInProgress()){ alert('Nelze mƒõnit typ hry v pr≈Øbƒõhu legu.'); syncGameOptionsUI(); return; }
  state.startingScore = Number(val);
  state.players.forEach(function(p){ p.remaining=state.startingScore; p.turnThrows=[]; });
  state.leg={ id:ts(), turns:[], startingScore:state.startingScore, doubleOut:state.doubleOut, createdAt:new Date().toISOString() };
  renderPlayers(); renderLiveHistory(); setStatus('Nastaveno '+state.startingScore+'.'); saveActive();
}
function toggleDoubleOut(on){ if(isInProgress()){ alert('Double-out lze mƒõnit jen p≈ôed legem.'); syncGameOptionsUI(); return;} state.doubleOut=on; saveActive(); }
function toggleSound(on){ state.soundOn=on; saveActive(); }

function startNewLeg(){
  if(state.players.length===0){ alert('P≈ôidejte alespo≈à jednoho hr√°ƒçe.'); return; }
  state.players.forEach(function(p){ p.remaining=state.startingScore; p.turnThrows=[]; });
  state.currentIndex=0;
  state.leg={ id:ts(), turns:[], startingScore:state.startingScore, doubleOut:state.doubleOut, createdAt:new Date().toISOString() };
  renderPlayers(); renderLiveHistory(); setStatus('Zaƒç√≠n√° nov√© kolo.'); updateUI(); saveActive();
}
function startGameRandom(){
  if(state.players.length===0){ alert('P≈ôidejte alespo≈à jednoho hr√°ƒçe.'); return; }
  for(var i=state.players.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var tmp=state.players[i]; state.players[i]=state.players[j]; state.players[j]=tmp; }
  startNewLeg();
  setStatus('Po≈ôad√≠: '+state.players.map(function(p){return p.name;}).join(', '));
}
function abortLeg(){
  if(!isInProgress()){ alert('Nen√≠ co ukonƒçit.'); return; }
  if(!confirm('Ukonƒçit rozehranou hru? Nedokonƒçen√Ω leg se ulo≈æ√≠.')) return;
  state.history.legs = state.history.legs || [];
  state.history.legs.push(Object.assign({}, state.leg, {aborted:true}));
  saveHistory();
  state.players.forEach(function(p){ p.remaining=state.startingScore; p.turnThrows=[]; });
  state.currentIndex=0;
  state.leg={ id:ts(), turns:[], startingScore:state.startingScore, doubleOut:state.doubleOut, createdAt:new Date().toISOString() };
  renderPlayers(); renderLiveHistory(); updateUI(); saveActive(); setStatus('Hra ukonƒçena.');
}
function currentPlayer(){ return state.players[state.currentIndex]; }
function nextPlayer(){ state.currentIndex = (state.currentIndex+1) % state.players.length; }

function enterScore(base, mul){
  mul = mul || state.multiplier;
  var p=currentPlayer(); if(!p){ alert('≈Ω√°dn√≠ hr√°ƒçi.'); return; }
  if(!p.turnThrows) p.turnThrows=[];
  if(p.turnThrows.length>=3){ finishTurn(); return; }

  var score = base*mul;
  playNumber(score);

  p.turnThrows.push({base:base,mul:mul,score:score});
  renderPlayers(); renderLiveHistory();

  // reset na Single
  state.multiplier=1;
  Array.prototype.forEach.call(document.querySelectorAll('#multiplier .chip'), function(c){ c.classList.remove('active'); });
  var sbtn=document.querySelector('#multiplier .chip[data-mul="1"]'); if(sbtn) sbtn.classList.add('active');

  if(p.turnThrows.length===3){ finishTurn(); }
  updateUI(); saveActive();
}
function finishTurn(){
  var p=currentPlayer(); if(!p) return;
  var darts=p.turnThrows||[];
  if(darts.length===0){ nextPlayer(); renderPlayers(); updateUI(); saveActive(); return; }

  var sum=darts.reduce(function(a,d){return a+d.score;},0);
  var remaining=p.remaining - sum;
  var bust=false;

  if(remaining<0){ bust=true; remaining=p.remaining; }
  else if(remaining===0){
    if(state.doubleOut){
      var last=darts[darts.length-1];
      if(last.mul!==2){ bust=true; remaining=p.remaining; }
    }
  } else if(state.doubleOut && remaining===1){ bust=true; remaining=p.remaining; }

  if(!bust){ p.remaining = remaining; }

  state.leg.turns = state.leg.turns || [];
  state.leg.turns.push({ playerId:p.id, playerName:p.name, darts:deepClone(darts), turnTotal:sum, bust:bust, remainingAfter:p.remaining, when:new Date().toISOString() });

  if(bust){ playWord('bust'); }
  if(p.remaining===0){
    playWord('vyhra');
    state.history.legs = state.history.legs || [];
    state.history.legs.push(Object.assign({}, state.leg, {winnerId:p.id}));
    var hp=(state.history.players||[]).find(function(x){return x.id===p.id;}); if(hp){ hp.wins=(hp.wins||0)+1; }
    saveHistory();
    alert('V√≠tƒõz: '+p.name+'!');
    startNewLeg(); renderLeaderboard(); updateUI(); saveActive(); return;
  }

  p.turnThrows=[];
  nextPlayer();
  renderPlayers(); renderLiveHistory(); saveHistory(); updateUI(); saveActive();
}
function undoLastDart(){
  var p=currentPlayer();
  if(p && p.turnThrows && p.turnThrows.length>0){
    p.turnThrows.pop();
    renderPlayers(); renderLiveHistory(); updateUI(); saveActive();
    return;
  }
  var last=state.leg.turns && state.leg.turns[state.leg.turns.length-1];
  if(!last){ setStatus('Nic k vr√°cen√≠.'); return; }
  var idx=state.players.findIndex(function(pl){ return pl.id===last.playerId; });
  if(idx!==-1) state.currentIndex=idx;
  var pl=currentPlayer();
  pl.remaining = last.bust ? pl.remaining : last.remainingAfter + last.turnTotal;
  pl.turnThrows = last.darts;
  state.leg.turns.pop();
  renderPlayers(); renderLiveHistory(); updateUI(); saveActive();
}

/* ====== Tipy (zkr√°cen√©) ====== */
var UNFINISHABLE=new Set([169,168,166,165,163,162,159]);
var TPR=[20,19,18,17,16,15];
function suggestDoubleOut(rem){
  var res=[]; if(rem>170||rem<=1||UNFINISHABLE.has(rem)) return res;
  if(rem===50) return [['D25']];
  if(rem%2===0 && rem<=40) return [['D'+(rem/2)]];
  for(var i=0;i<TPR.length;i++){ var t=TPR[i]; var r=rem-3*t;
    if(r===50){ res.push(['T'+t,'D25']); break; }
    if(r>0 && r%2===0 && r<=40){ res.push(['T'+t,'D'+(r/2)]); if(res.length>=3) break; }
  }
  return res;
}
function suggestSingleOut(rem){
  var res=[]; if(rem<=0) return res;
  if(rem<=50){ if(rem===50) return [['Bull']]; return [['S'+rem]]; }
  for(var i=0;i<TPR.length;i++){ var t=TPR[i]; var r=rem-3*t;
    if(r>=0 && r<=50){ if(r===50) res.push(['T'+t,'Bull']); else res.push(['T'+t,'S'+r]); if(res.length>=3) break; }
  }
  return res;
}
function renderTips(){
  var box=document.getElementById('checkoutTips'); if(!box) return;
  var show=(document.getElementById('showTips')||{}).checked!==false;
  if(!show){ box.textContent=''; return; }
  var p=currentPlayer(); if(!p){ box.textContent=''; return; }
  var rem=p.remaining; // jen aktu√°ln√≠ hodnota
  var limit = state.doubleOut ? 170 : 120;
  if(rem<=0 || rem>limit || UNFINISHABLE.has(rem)){ box.textContent=''; return; }
  var tips = state.doubleOut? suggestDoubleOut(rem) : suggestSingleOut(rem);
  box.textContent = tips.length ? ('Tipy: ' + tips.map(function(a){return a.join(' ‚Üí ');}).join(' | ')) : '';
}

/* ====== Renderov√°n√≠ ====== */
function renderPlayers(){
  var box=document.getElementById('players'); box.innerHTML='';
  state.players.forEach(function(p,i){
    var throwsText = (p.turnThrows && p.turnThrows.length) ? ' ['+p.turnThrows.map(formatDartShort).join(', ')+']' : '';
    var el=document.createElement('div'); el.className='player';
    el.innerHTML = '<div style="display:flex;align-items:center;gap:8px">'
      +'<div class="pill" style="'+(i===state.currentIndex?'outline:2px solid var(--accent);':'')+'">'+(i===state.currentIndex?'‚ñ∂Ô∏è':'')+' '+(i+1)+'</div>'
      +'<div class="name">'+escapeHtml(p.name)+throwsText+'</div>'
      +'</div>'
      +'<div style="display:flex;align-items:center;gap:8px">'
      +'<div class="score">'+p.remaining+'</div>'
      +'<button class="ghost" title="Odebrat" onclick="removePlayer(\''+p.id+'\')">‚úñ</button>'
      +'</div>';
    box.appendChild(el);
  });
  updateTurnInfo(); updateSticky(); updateTopBar(); renderTips();
}
function renderLiveHistory(){
  var box=document.getElementById('liveHistory'); if(!box) return; box.innerHTML='';
  var p=currentPlayer();
  if(p && p.turnThrows && p.turnThrows.length){
    var row=document.createElement('div'); row.className='hist-row';
    row.innerHTML = '<div><b>'+escapeHtml(p.name)+'</b> ‚Äì rozpracovan√Ω tah: '+p.turnThrows.map(formatDart).join(', ')+' (= '+p.turnThrows.reduce(function(a,d){return a+d.score;},0)+')</div>';
    box.appendChild(row);
  }
  for(var i=state.leg.turns.length-1;i>=0;i--){
    var t=state.leg.turns[i]; var row2=document.createElement('div'); row2.className='hist-row';
    row2.innerHTML = '<div><b>'+escapeHtml(t.playerName)+'</b> ‚Üí '+t.darts.map(formatDart).join(', ')
      +' <span class="muted">(='+t.turnTotal+')</span> '+(t.bust?'<span style="color:var(--warn)">BUST</span>':'')
      +' <span class="muted small">z≈Østatek: '+t.remainingAfter+'</span></div>';
    box.appendChild(row2);
  }
}
function renderFullHistory(){
  var box=document.getElementById('fullHistory'); if(!box) return; box.innerHTML='';
  if(!state.history.legs || state.history.legs.length===0){ box.innerHTML='<div class="hist-row muted">Zat√≠m ≈æ√°dn√° odehran√° kola.</div>'; return; }
  state.history.legs.slice().reverse().forEach(function(leg,idx){
    var wrap=document.createElement('div'); wrap.className='hist-row';
    var winner=(state.history.players||[]).find(function(p){return p.id===leg.winnerId;});
    wrap.innerHTML = '<div><b>Leg #'+(state.history.legs.length-idx)+'</b> ‚Ä¢ start: '+(leg.startingScore||'-')+' ‚Ä¢ '+(leg.doubleOut?'double-out':'standard')+(leg.aborted?' ‚Ä¢ <span style="color:var(--warn)">ukonƒçeno</span>':'')+' ‚Ä¢ v√≠tƒõz: <b>'+(winner?escapeHtml(winner.name):'‚Äî')+'</b> <span class="small muted">'+new Date(leg.createdAt||Date.now()).toLocaleString()+'</span></div>';
    (leg.turns||[]).forEach(function(t){
      var line=document.createElement('div'); line.className='small muted'; line.style.marginLeft='8px';
      line.textContent = t.playerName+': '+t.darts.map(function(d){return d.mul+'√ó'+d.base+'='+d.score;}).join(', ')+' = '+t.turnTotal+(t.bust?' (BUST)':'')+' ‚Üí '+t.remainingAfter;
      wrap.appendChild(line);
    });
    box.appendChild(wrap);
  });
}
function renderLeaderboard(){
  var tbody=document.querySelector('#leaderTable tbody'); if(!tbody) return;
  var arr=(state.history.players||[]).slice().sort(function(a,b){return (b.wins||0)-(a.wins||0);});
  tbody.innerHTML = arr.map(function(p,i){return '<tr><td>'+(i+1)+'.</td><td>'+escapeHtml(p.name)+'</td><td>'+(p.wins||0)+'</td></tr>';}).join('');
}

function updateTurnInfo(){
  var el=document.getElementById('turnInfo'); var p=currentPlayer();
  el.innerHTML = p ? 'Na tahu: <b>'+escapeHtml(p.name)+'</b> ‚Ä¢ Zb√Ωv√°: '+p.remaining : 'Na tahu: ‚Äì';
}
function updateSticky(){
  var bar=document.getElementById('stickyBar'); if(!bar) return;
  var p=currentPlayer(); var throwTxt = (p && p.turnThrows && p.turnThrows.length) ? p.turnThrows.map(formatDartShort).join(', ') : '‚Äî';
  bar.innerHTML = p ? 'Na tahu: <b>'+escapeHtml(p.name)+'</b> ‚Ä¢ Zb√Ωv√°: <b>'+p.remaining+'</b> ‚Ä¢ Hody: '+throwTxt : '‚Äî';
}
function updateTopBar(){
  var top=document.getElementById('activeTop'); if(!top) return;
  var playing=isInProgress(); top.style.display=playing?'flex':'none'; if(!playing) return;
  var p=currentPlayer();
  document.getElementById('activeTopName').textContent = p? p.name : '‚Äî';
  document.getElementById('activeTopRemain').textContent = p? ('Zb√Ωv√°: '+p.remaining) : '';
  var throwTxt=(p && p.turnThrows && p.turnThrows.length) ? p.turnThrows.map(formatDartShort).join(', ') : '‚Äî';
  document.getElementById('activeTopThrows').textContent='Hody: '+throwTxt;
}
function updateUI(){ document.body.classList.toggle('playing', isInProgress()); updateSticky(); updateTopBar(); renderTips(); }

function formatDart(d){ var m=d.mul===1?'S':(d.mul===2?'D':'T'); return m+''+d.base+'='+d.score; }
function formatDartShort(d){ var m=d.mul===1?'S':(d.mul===2?'D':'T'); return m+''+d.base; }
function escapeHtml(s){ s=(s+""); return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ====== Export / import ====== */
function downloadHistory(){
  var data = JSON.stringify(state.history, null, 2);
  var blob = new Blob([data], {type:'application/json'});
  var url = URL.createObjectURL(blob);
  var a=document.createElement('a'); a.href=url; a.download='darts_history_'+new Date().toISOString().replace(/[:]/g,'-')+'.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importHistory(){
  var inp=document.getElementById('importFile'); if(!inp.files.length){ alert('Vyberte JSON.'); return; }
  var f=inp.files[0]; var r=new FileReader();
  r.onload = function(){ try{ var obj=JSON.parse(r.result); if(!obj.players||!obj.legs) throw new Error('Neplatn√Ω form√°t'); state.history=obj; saveHistory(); renderFullHistory(); renderLeaderboard(); alert('Naƒçteno.'); }catch(e){ alert('Chyba: '+e.message); } };
  r.readAsText(f);
}
function clearAll(){ if(!confirm('Opravdu smazat ve≈°kerou historii?')) return; state.history={players:[],legs:[]}; saveHistory(); renderFullHistory(); renderLeaderboard(); }

/* ====== Ovl√°dac√≠ prvky ====== */
function bindGameOptions(){
  var box=document.getElementById('gameOptions'); if(!box) return;
  box.addEventListener('change', function(e){
    var t=e.target; if(!t || !t.tagName) return;
    var id=t.id||'';
    if(t.name==='x01'){ setGame(Number(t.value)); syncGameOptionsUI(); }
    else if(id==='doubleOut'){ toggleDoubleOut(t.checked); }
    else if(id==='soundToggle'){ toggleSound(t.checked); }
  });
}
function syncGameOptionsUI(){
  var cur=String(state.startingScore);
  Array.prototype.forEach.call(document.querySelectorAll('input[name="x01"]'), function(r){ r.checked=(r.value===cur); });
  var d=document.getElementById('doubleOut'); if(d) d.checked=!!state.doubleOut;
  var s=document.getElementById('soundToggle'); if(s) s.checked=!!state.soundOn;
}
function buildKeypad(){
  var pad=document.getElementById('keypad'); pad.innerHTML='';
  var nums=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,25,50];
  nums.forEach(function(n){ var b=document.createElement('button'); b.className='key'; b.textContent=n; b.addEventListener('click',function(){ enterScore(n); }); pad.appendChild(b); });
  var miss=document.createElement('button'); miss.className='key miss'; miss.textContent='Miss'; miss.addEventListener('click',function(){ enterScore(0,1); }); pad.appendChild(miss);
}

/* ====== Init ====== */
  applyTheme(loadTheme());
bindThemeUI();
buildKeypad();
bindGameOptions();
renderPlayers(); renderLiveHistory(); updateUI();
var saved=loadActive();
if(saved && saved.players && saved.players.length){
  state.startingScore = (saved.startingScore != null ? saved.startingScore : state.startingScore);
  state.doubleOut    = !!saved.doubleOut;
  state.players      = saved.players;
  state.currentIndex = saved.currentIndex || 0;
  state.leg          = saved.leg || state.leg;
  state.soundOn      = (saved.soundOn !== false);
  renderPlayers(); renderLiveHistory();
}
syncGameOptionsUI(); updateUI();

/* zp≈ô√≠stupnƒõn√≠ pro inline onclick (Samsung Internet, atd.) */
window.addPlayer       = addPlayer;
window.startGameRandom = startGameRandom;
window.startNewLeg     = startNewLeg;
window.abortLeg        = abortLeg;
window.undoLastDart    = undoLastDart;
window.enterScore      = enterScore;
window.finishTurn      = finishTurn;
</script>
</body>
</html>
